/*!
 * OpenTok JavaScript Library v2.0.4
 * http://www.tokbox.com/
 *
 * Copyright (c) 2011 TokBox, Inc.
 *
 * Date: April 23 08:50:23 2013
 */

(function(){var x=this;var k=x._;var E={};var D=Array.prototype,f=Object.prototype,s=Function.prototype;var H=D.push,p=D.slice,z=D.concat,d=f.toString,j=f.hasOwnProperty;var L=D.forEach,r=D.map,F=D.reduce,c=D.reduceRight,b=D.filter,C=D.every,q=D.some,o=D.indexOf,m=D.lastIndexOf,v=Array.isArray,e=Object.keys,G=s.bind;var M=function(N){if(N instanceof M){return N}if(!(this instanceof M)){return new M(N)}this._wrapped=N};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=M}exports._=M}else{x._=M}M.VERSION="1.4.4";var I=M.each=M.forEach=function(S,R,Q){if(S==null){return}if(L&&S.forEach===L){S.forEach(R,Q)}else{if(S.length===+S.length){for(var P=0,N=S.length;P<N;P++){if(R.call(Q,S[P],P,S)===E){return}}}else{for(var O in S){if(M.has(S,O)){if(R.call(Q,S[O],O,S)===E){return}}}}}};M.map=M.collect=function(Q,P,O){var N=[];if(Q==null){return N}if(r&&Q.map===r){return Q.map(P,O)}I(Q,function(T,R,S){N[N.length]=P.call(O,T,R,S)});return N};var g="Reduce of empty array with no initial value";M.reduce=M.foldl=M.inject=function(R,Q,N,P){var O=arguments.length>2;if(R==null){R=[]}if(F&&R.reduce===F){if(P){Q=M.bind(Q,P)}return O?R.reduce(Q,N):R.reduce(Q)}I(R,function(U,S,T){if(!O){N=U;O=true}else{N=Q.call(P,N,U,S,T)}});if(!O){throw new TypeError(g)}return N};M.reduceRight=M.foldr=function(T,Q,N,P){var O=arguments.length>2;if(T==null){T=[]}if(c&&T.reduceRight===c){if(P){Q=M.bind(Q,P)}return O?T.reduceRight(Q,N):T.reduceRight(Q)}var S=T.length;if(S!==+S){var R=M.keys(T);S=R.length}I(T,function(W,U,V){U=R?R[--S]:--S;if(!O){N=T[U];O=true}else{N=Q.call(P,N,T[U],U,V)}});if(!O){throw new TypeError(g)}return N};M.find=M.detect=function(Q,P,O){var N;B(Q,function(T,R,S){if(P.call(O,T,R,S)){N=T;return true}});return N};M.filter=M.select=function(Q,P,O){var N=[];if(Q==null){return N}if(b&&Q.filter===b){return Q.filter(P,O)}I(Q,function(T,R,S){if(P.call(O,T,R,S)){N[N.length]=T}});return N};M.reject=function(P,O,N){return M.filter(P,function(S,Q,R){return !O.call(N,S,Q,R)},N)};M.every=M.all=function(Q,P,O){P||(P=M.identity);var N=true;if(Q==null){return N}if(C&&Q.every===C){return Q.every(P,O)}I(Q,function(T,R,S){if(!(N=N&&P.call(O,T,R,S))){return E}});return !!N};var B=M.some=M.any=function(Q,P,O){P||(P=M.identity);var N=false;if(Q==null){return N}if(q&&Q.some===q){return Q.some(P,O)}I(Q,function(T,R,S){if(N||(N=P.call(O,T,R,S))){return E}});return !!N};M.contains=M.include=function(O,N){if(O==null){return false}if(o&&O.indexOf===o){return O.indexOf(N)!=-1}return B(O,function(P){return P===N})};M.invoke=function(P,Q){var N=p.call(arguments,2);var O=M.isFunction(Q);return M.map(P,function(R){return(O?Q:R[Q]).apply(R,N)})};M.pluck=function(O,N){return M.map(O,function(P){return P[N]})};M.where=function(O,N,P){if(M.isEmpty(N)){return P?null:[]}return M[P?"find":"filter"](O,function(R){for(var Q in N){if(N[Q]!==R[Q]){return false}}return true})};M.findWhere=function(O,N){return M.where(O,N,true)};M.max=function(Q,P,O){if(!P&&M.isArray(Q)&&Q[0]===+Q[0]&&Q.length<65535){return Math.max.apply(Math,Q)}if(!P&&M.isEmpty(Q)){return -Infinity}var N={computed:-Infinity,value:-Infinity};I(Q,function(U,R,T){var S=P?P.call(O,U,R,T):U;S>=N.computed&&(N={value:U,computed:S})});return N.value};M.min=function(Q,P,O){if(!P&&M.isArray(Q)&&Q[0]===+Q[0]&&Q.length<65535){return Math.min.apply(Math,Q)}if(!P&&M.isEmpty(Q)){return Infinity}var N={computed:Infinity,value:Infinity};I(Q,function(U,R,T){var S=P?P.call(O,U,R,T):U;S<N.computed&&(N={value:U,computed:S})});return N.value};M.shuffle=function(Q){var P;var O=0;var N=[];I(Q,function(R){P=M.random(O++);N[O-1]=N[P];N[P]=R});return N};var a=function(N){return M.isFunction(N)?N:function(O){return O[N]}};M.sortBy=function(Q,P,N){var O=a(P);return M.pluck(M.map(Q,function(T,R,S){return{value:T,index:R,criteria:O.call(N,T,R,S)}}).sort(function(U,T){var S=U.criteria;var R=T.criteria;if(S!==R){if(S>R||S===void 0){return 1}if(S<R||R===void 0){return -1}}return U.index<T.index?-1:1}),"value")};var u=function(S,R,O,Q){var N={};var P=a(R||M.identity);I(S,function(V,T){var U=P.call(O,V,T,S);Q(N,U,V)});return N};M.groupBy=function(P,O,N){return u(P,O,N,function(Q,R,S){(M.has(Q,R)?Q[R]:(Q[R]=[])).push(S)})};M.countBy=function(P,O,N){return u(P,O,N,function(Q,R){if(!M.has(Q,R)){Q[R]=0}Q[R]++})};M.sortedIndex=function(U,T,Q,P){Q=Q==null?M.identity:a(Q);var S=Q.call(P,T);var N=0,R=U.length;while(N<R){var O=(N+R)>>>1;Q.call(P,U[O])<S?N=O+1:R=O}return N};M.toArray=function(N){if(!N){return[]}if(M.isArray(N)){return p.call(N)}if(N.length===+N.length){return M.map(N,M.identity)}return M.values(N)};M.size=function(N){if(N==null){return 0}return(N.length===+N.length)?N.length:M.keys(N).length};M.first=M.head=M.take=function(P,O,N){if(P==null){return void 0}return(O!=null)&&!N?p.call(P,0,O):P[0]};M.initial=function(P,O,N){return p.call(P,0,P.length-((O==null)||N?1:O))};M.last=function(P,O,N){if(P==null){return void 0}if((O!=null)&&!N){return p.call(P,Math.max(P.length-O,0))}else{return P[P.length-1]}};M.rest=M.tail=M.drop=function(P,O,N){return p.call(P,(O==null)||N?1:O)};M.compact=function(N){return M.filter(N,M.identity)};var y=function(O,P,N){I(O,function(Q){if(M.isArray(Q)){P?H.apply(N,Q):y(Q,P,N)}else{N.push(Q)}});return N};M.flatten=function(O,N){return y(O,N,[])};M.without=function(N){return M.difference(N,p.call(arguments,1))};M.uniq=M.unique=function(T,S,R,Q){if(M.isFunction(S)){Q=R;R=S;S=false}var O=R?M.map(T,R,Q):T;var P=[];var N=[];I(O,function(V,U){if(S?(!U||N[N.length-1]!==V):!M.contains(N,V)){N.push(V);P.push(T[U])}});return P};M.union=function(){return M.uniq(z.apply(D,arguments))};M.intersection=function(O){var N=p.call(arguments,1);return M.filter(M.uniq(O),function(P){return M.every(N,function(Q){return M.indexOf(Q,P)>=0})})};M.difference=function(O){var N=z.apply(D,p.call(arguments,1));return M.filter(O,function(P){return !M.contains(N,P)})};M.zip=function(){var N=p.call(arguments);var Q=M.max(M.pluck(N,"length"));var P=new Array(Q);for(var O=0;O<Q;O++){P[O]=M.pluck(N,""+O)}return P};M.object=function(R,P){if(R==null){return{}}var N={};for(var Q=0,O=R.length;Q<O;Q++){if(P){N[R[Q]]=P[Q]}else{N[R[Q][0]]=R[Q][1]}}return N};M.indexOf=function(R,P,Q){if(R==null){return -1}var O=0,N=R.length;if(Q){if(typeof Q=="number"){O=(Q<0?Math.max(0,N+Q):Q)}else{O=M.sortedIndex(R,P);return R[O]===P?O:-1}}if(o&&R.indexOf===o){return R.indexOf(P,Q)}for(;O<N;O++){if(R[O]===P){return O}}return -1};M.lastIndexOf=function(R,P,Q){if(R==null){return -1}var N=Q!=null;if(m&&R.lastIndexOf===m){return N?R.lastIndexOf(P,Q):R.lastIndexOf(P)}var O=(N?Q:R.length);while(O--){if(R[O]===P){return O}}return -1};M.range=function(S,Q,R){if(arguments.length<=1){Q=S||0;S=0}R=arguments[2]||1;var O=Math.max(Math.ceil((Q-S)/R),0);var N=0;var P=new Array(O);while(N<O){P[N++]=S;S+=R}return P};M.bind=function(P,O){if(P.bind===G&&G){return G.apply(P,p.call(arguments,1))}var N=p.call(arguments,2);return function(){return P.apply(O,N.concat(p.call(arguments)))}};M.partial=function(O){var N=p.call(arguments,1);return function(){return O.apply(this,N.concat(p.call(arguments)))}};M.bindAll=function(O){var N=p.call(arguments,1);if(N.length===0){N=M.functions(O)}I(N,function(P){O[P]=M.bind(O[P],O)});return O};M.memoize=function(P,O){var N={};O||(O=M.identity);return function(){var Q=O.apply(this,arguments);return M.has(N,Q)?N[Q]:(N[Q]=P.apply(this,arguments))}};M.delay=function(O,P){var N=p.call(arguments,2);return setTimeout(function(){return O.apply(null,N)},P)};M.defer=function(N){return M.delay.apply(M,[N,1].concat(p.call(arguments,1)))};M.throttle=function(S,U){var Q,P,T,N;var R=0;var O=function(){R=new Date;T=null;N=S.apply(Q,P)};return function(){var V=new Date;var W=U-(V-R);Q=this;P=arguments;if(W<=0){clearTimeout(T);T=null;R=V;N=S.apply(Q,P)}else{if(!T){T=setTimeout(O,W)}}return N}};M.debounce=function(P,R,O){var Q,N;return function(){var V=this,U=arguments;var T=function(){Q=null;if(!O){N=P.apply(V,U)}};var S=O&&!Q;clearTimeout(Q);Q=setTimeout(T,R);if(S){N=P.apply(V,U)}return N}};M.once=function(P){var N=false,O;return function(){if(N){return O}N=true;O=P.apply(this,arguments);P=null;return O}};M.wrap=function(N,O){return function(){var P=[N];H.apply(P,arguments);return O.apply(this,P)}};M.compose=function(){var N=arguments;return function(){var O=arguments;for(var P=N.length-1;P>=0;P--){O=[N[P].apply(this,O)]}return O[0]}};M.after=function(O,N){if(O<=0){return N()}return function(){if(--O<1){return N.apply(this,arguments)}}};M.keys=e||function(P){if(P!==Object(P)){throw new TypeError("Invalid object")}var O=[];for(var N in P){if(M.has(P,N)){O[O.length]=N}}return O};M.values=function(P){var N=[];for(var O in P){if(M.has(P,O)){N.push(P[O])}}return N};M.pairs=function(P){var O=[];for(var N in P){if(M.has(P,N)){O.push([N,P[N]])}}return O};M.invert=function(P){var N={};for(var O in P){if(M.has(P,O)){N[P[O]]=O}}return N};M.functions=M.methods=function(P){var O=[];for(var N in P){if(M.isFunction(P[N])){O.push(N)}}return O.sort()};M.extend=function(N){I(p.call(arguments,1),function(O){if(O){for(var P in O){N[P]=O[P]}}});return N};M.pick=function(O){var P={};var N=z.apply(D,p.call(arguments,1));I(N,function(Q){if(Q in O){P[Q]=O[Q]}});return P};M.omit=function(P){var Q={};var O=z.apply(D,p.call(arguments,1));for(var N in P){if(!M.contains(O,N)){Q[N]=P[N]}}return Q};M.defaults=function(N){I(p.call(arguments,1),function(O){if(O){for(var P in O){if(N[P]==null){N[P]=O[P]}}}});return N};M.clone=function(N){if(!M.isObject(N)){return N}return M.isArray(N)?N.slice():M.extend({},N)};M.tap=function(O,N){N(O);return O};var J=function(U,T,O,P){if(U===T){return U!==0||1/U==1/T}if(U==null||T==null){return U===T}if(U instanceof M){U=U._wrapped}if(T instanceof M){T=T._wrapped}var R=d.call(U);if(R!=d.call(T)){return false}switch(R){case"[object String]":return U==String(T);case"[object Number]":return U!=+U?T!=+T:(U==0?1/U==1/T:U==+T);case"[object Date]":case"[object Boolean]":return +U==+T;case"[object RegExp]":return U.source==T.source&&U.global==T.global&&U.multiline==T.multiline&&U.ignoreCase==T.ignoreCase}if(typeof U!="object"||typeof T!="object"){return false}var N=O.length;while(N--){if(O[N]==U){return P[N]==T}}O.push(U);P.push(T);var W=0,X=true;if(R=="[object Array]"){W=U.length;X=W==T.length;if(X){while(W--){if(!(X=J(U[W],T[W],O,P))){break}}}}else{var S=U.constructor,Q=T.constructor;if(S!==Q&&!(M.isFunction(S)&&(S instanceof S)&&M.isFunction(Q)&&(Q instanceof Q))){return false}for(var V in U){if(M.has(U,V)){W++;if(!(X=M.has(T,V)&&J(U[V],T[V],O,P))){break}}}if(X){for(V in T){if(M.has(T,V)&&!(W--)){break}}X=!W}}O.pop();P.pop();return X};M.isEqual=function(O,N){return J(O,N,[],[])};M.isEmpty=function(O){if(O==null){return true}if(M.isArray(O)||M.isString(O)){return O.length===0}for(var N in O){if(M.has(O,N)){return false}}return true};M.isElement=function(N){return !!(N&&N.nodeType===1)};M.isArray=v||function(N){return d.call(N)=="[object Array]"};M.isObject=function(N){return N===Object(N)};I(["Arguments","Function","String","Number","Date","RegExp"],function(N){M["is"+N]=function(O){return d.call(O)=="[object "+N+"]"}});if(!M.isArguments(arguments)){M.isArguments=function(N){return !!(N&&M.has(N,"callee"))}}if(typeof(/./)!=="function"){M.isFunction=function(N){return typeof N==="function"}}M.isFinite=function(N){return isFinite(N)&&!isNaN(parseFloat(N))};M.isNaN=function(N){return M.isNumber(N)&&N!=+N};M.isBoolean=function(N){return N===true||N===false||d.call(N)=="[object Boolean]"};M.isNull=function(N){return N===null};M.isUndefined=function(N){return N===void 0};M.has=function(O,N){return j.call(O,N)};M.noConflict=function(){x._=k;return this};M.identity=function(N){return N};M.times=function(R,Q,P){var N=Array(R);for(var O=0;O<R;O++){N[O]=Q.call(P,O)}return N};M.random=function(O,N){if(N==null){N=O;O=0}return O+Math.floor(Math.random()*(N-O+1))};var n={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};n.unescape=M.invert(n.escape);var K={escape:new RegExp("["+M.keys(n.escape).join("")+"]","g"),unescape:new RegExp("("+M.keys(n.unescape).join("|")+")","g")};M.each(["escape","unescape"],function(N){M[N]=function(O){if(O==null){return""}return(""+O).replace(K[N],function(P){return n[N][P]})}});M.result=function(N,P){if(N==null){return null}var O=N[P];return M.isFunction(O)?O.call(N):O};M.mixin=function(N){I(M.functions(N),function(O){var P=M[O]=N[O];M.prototype[O]=function(){var Q=[this._wrapped];H.apply(Q,arguments);return t.call(this,P.apply(M,Q))}})};var A=0;M.uniqueId=function(N){var O=++A+"";return N?N+O:O};M.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var w=/(.)^/;var h={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"};var i=/\\|'|\r|\n|\t|\u2028|\u2029/g;M.template=function(V,Q,P){var O;P=M.defaults({},P,M.templateSettings);var R=new RegExp([(P.escape||w).source,(P.interpolate||w).source,(P.evaluate||w).source].join("|")+"|$","g");var S=0;var N="__p+='";V.replace(R,function(X,Y,W,aa,Z){N+=V.slice(S,Z).replace(i,function(ab){return"\\"+h[ab]});if(Y){N+="'+\n((__t=("+Y+"))==null?'':_.escape(__t))+\n'"}if(W){N+="'+\n((__t=("+W+"))==null?'':__t)+\n'"}if(aa){N+="';\n"+aa+"\n__p+='"}S=Z+X.length;return X});N+="';\n";if(!P.variable){N="with(obj||{}){\n"+N+"}\n"}N="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+N+"return __p;\n";try{O=new Function(P.variable||"obj","_",N)}catch(T){T.source=N;throw T}if(Q){return O(Q,M)}var U=function(W){return O.call(this,W,M)};U.source="function("+(P.variable||"obj")+"){\n"+N+"}";return U};M.chain=function(N){return M(N).chain()};var t=function(N){return this._chain?M(N).chain():N};M.mixin(M);I(["pop","push","reverse","shift","sort","splice","unshift"],function(N){var O=D[N];M.prototype[N]=function(){var P=this._wrapped;O.apply(P,arguments);if((N=="shift"||N=="splice")&&P.length===0){delete P[0]}return t.call(this,P)}});I(["concat","join","slice"],function(N){var O=D[N];M.prototype[N]=function(){return t.call(this,O.apply(this._wrapped,arguments))}});M.extend(M.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this);
/*
 *  This is a modified version of Robert Kieffer awesome uuid.js library.
 *  The only modifications we've made are to remove the Node.js specific
 *  parts of the code and the UUID version 1 generator (which we don't
 *  use). The original copyright notice is below.
 *
 *     node-uuid/uuid.js
 *
 *     Copyright (c) 2010 Robert Kieffer
 *     Dual licensed under the MIT and GPL licenses.
 *     Documentation and details at https://github.com/broofa/node-uuid
 */
(function(){var n=this;var f,e;var q=new Array(16);f=function(){var u,s=q,t=0;for(t=0;t<16;t++){if((t&3)===0){u=Math.random()*4294967296}s[t]=u>>>((t&3)<<3)&255}return s};if(n.crypto&&crypto.getRandomValues){var b=new Uint32Array(4);e=function(){crypto.getRandomValues(b);for(var i=0;i<16;i++){q[i]=b[i>>2]>>>((i&3)*8)&255}return q}}var d=e||f;var m=typeof(Buffer)=="function"?Buffer:Array;var p=[];var j={};for(var h=0;h<256;h++){p[h]=(h+256).toString(16).substr(1);j[p[h]]=h}function g(v,r,w){var t=(r&&w)||0,u=0;r=r||[];v.toLowerCase().replace(/[0-9a-f]{2}/g,function(i){if(u<16){r[t+u++]=j[i]}});while(u<16){r[t+u++]=0}return r}function k(r,t){var s=t||0,u=p;return u[r[s++]]+u[r[s++]]+u[r[s++]]+u[r[s++]]+"-"+u[r[s++]]+u[r[s++]]+"-"+u[r[s++]]+u[r[s++]]+"-"+u[r[s++]]+u[r[s++]]+"-"+u[r[s++]]+u[r[s++]]+u[r[s++]]+u[r[s++]]+u[r[s++]]+u[r[s++]]}function o(s,r,w){var t=r&&w||0;if(typeof(s)=="string"){r=s=="binary"?new m(16):null;s=null}s=s||{};var v=s.random||(s.rng||d)();v[6]=(v[6]&15)|64;v[8]=(v[8]&63)|128;if(r){for(var u=0;u<16;u++){r[t+u]=v[u]}}return r||k(v)}var a=o;a.v4=o;a.parse=g;a.unparse=k;a.BufferClass=m;a.mathRNG=f;a.whatwgRNG=e;var c=n.uuid;a.noConflict=function(){n.uuid=c;return a};n.uuid=a}());(function(c){if(location.protocol==="file:"){alert("You cannot test a page using WebRTC through the file system due to browser permissions. You must run it over a web server.")}if(!c.URL&&c.webkitURL){c.URL=c.webkitURL}var a=0,b,e=document.location.hash,f;var d={initSession:function(g){if(!this.sessions[g]){this.sessions[g]=new d.Session(g)}return this.sessions[g]},initPublisher:function(j,g,h){d.debug("TB.initPublisher("+g+")");var i=new d.rtc.Publisher();i.publish(g,h);return i},checkSystemRequirements:function(){d.debug("TB.checkSystemRequirements()");var g=d.$.supportsWebSockets()&&d.$.supportsWebRTC()?this.HAS_REQUIREMENTS:this.NOT_HAS_REQUIREMENTS;d.checkSystemRequirements=function(){d.debug("TB.checkSystemRequirements()");return g};return g},upgradeSystemRequirements:function(){d.onLoad(function(){var k=false,m=document.getElementsByTagName("meta");for(var h=0;h<m.length;h++){var g=m[h].httpEquiv,j=m[h].content;if(g&&g.toLowerCase()=="x-ua-compatible"&&j&&j.toLowerCase().indexOf("chrome=1")>-1){k=true;break}}var n="_upgradeFlash";document.body.appendChild((function(){var o=document.createElement("iframe");o.id=n;o.style.position="absolute";o.style.position="fixed";o.style.height="100%";o.style.width="100%";o.style.top="0px";o.style.left="0px";o.style.right="0px";o.style.bottom="0px";o.style.zIndex=1000;try{o.style.backgroundColor="rgba(0,0,0,0.2)"}catch(i){o.style.backgroundColor="transparent";o.setAttribute("allowTransparency","true")}o.setAttribute("frameBorder","0");o.frameBorder="0";o.scrolling="no";o.setAttribute("scrolling","no");o.src=d.BUILD_PROPERTIES.widgetURL+"/html/upgradeFlash.html"+(k?"?cf=1":"")+"#"+encodeURIComponent(document.location.href);return o})());if(b){clearInterval(b)}b=setInterval(function(){var o=document.location.hash,i=/^#?\d+&/;if(o!==e&&i.test(o)){e=o;if(o.replace(i,"")==="close_window"){document.body.removeChild(document.getElementById(n));document.location.hash=""}else{if(o.replace(i,"")==="installed_gcf"){document.location.hash="";document.location.href=document.location.href.replace("#","")}}}},100)})},reportIssue:function(){d.warn("ToDo: haven't yet implemented TB.reportIssue")},components:{},sessions:{},rtc:{},behaviours:{},APIKEY:(function(){var h=(function(){var i=document.getElementsByTagName("script");i=i[i.length-1];i=i.getAttribute("src")||i.src;return i})();var g=h.match(/[\?\&]apikey=([^&]+)/i);return g?g[1]:""})(),HAS_REQUIREMENTS:1,NOT_HAS_REQUIREMENTS:0};d._=_.noConflict();c.OT=d;c.TB=d})(window);OT.BUILD_PROPERTIES={baseURL:"http://www.tokbox.com",apiURL:"http://anvil.opentok.com",messagingServer:"staging.tokbox.com",loggingURL:"http://hlg.tokbox.com/prod",widgetURL:"http://static.opentok.com/webrtc/v2.0.4",version:"v2.0.4",debug:false};if(true&&window.location.protocol.indexOf("https")>=0){OT.BUILD_PROPERTIES.widgetURL="https://swww.tokbox.com/webrtc/v2.0.4";OT.BUILD_PROPERTIES.loggingURL="https://api.opentok.com/hl";OT.BUILD_PROPERTIES.apiURL="https://anvil.opentok.com"}OT.BUILD_PROPERTIES.configURL=OT.BUILD_PROPERTIES.widgetURL+"/js/dynamic_config.min.js";OT.BUILD_PROPERTIES.cssURL=OT.BUILD_PROPERTIES.widgetURL+"/css";(function(b){OT.$=function(c){return document.getElementById(c)};OT.$.noop=function(){};OT.$.supportsWebSockets=function(){return"WebSocket" in b};OT.$.now=(function(){var d=b.performance||{},c=d.now||d.mozNow||d.msNow||d.oNow||d.webkitNow;if(c){return c.bind(d)}else{return function(){return new Date().getTime()}}})();OT.$.browser=function(){var d=b.navigator.userAgent.toLowerCase(),e,c="Unknown";if(d.indexOf("firefox")>-1){c="Firefox"}if(d.indexOf("opera")>-1){c="Opera"}else{if(d.indexOf("msie")>-1){c="IE"}else{if(d.indexOf("chrome")>-1){c="Chrome"}}}if((e=b.navigator.vendor)&&e.toLowerCase().indexOf("apple")>-1){c="Safari"}d=null;OT.$.browser=function(){return c};return c};OT.$.moreInfoLink=function(d){var e=d?d.apiKey:OT.APIKEY,c=["http://www.tokbox.com/opentok/info"];c[0]+="?guid=a80c00ad22a3e7dcee262f5f7c549c94c794d663";if(d){c.push("session_id="+d.id);if(d.connected){c.push("connection_id="+d.connection.id)}}c.push("partner_id="+e);c.push("utm_source="+e);c.push("utm_medium="+OT.$.browser());if(OT.BUILD_PROPERTIES.widgetURL.indexOf("static")>-1){c.push("utm_campaign=static")}else{c.push("utm_campaign=staging")}return c.join("&")};OT.$.deepClone=function(e){if(!OT._.isObject(e)){return e}var c=OT._.isArray(e)?[]:{};for(var d in e){if(!e.hasOwnProperty(d)){continue}if(OT._.isObject(e[d])){c[d]=this.deepClone(e[d])}else{c[d]=e[d]}}return c};OT.$.JSONify=(b.JSON&&b.JSON.stringify)?b.JSON.stringify:function(d){var c="{ ";for(var e in d){if(typeof(d[e])=="boolean"){c+='"'+e+'":'+d[e]+", "}else{c+='"'+e+'":"'+d[e].toString()+'", '}}if(c.length>1){c=c.substring(0,c.length-2)+" }"}else{c="{}"}return c};OT.$.tbAlert=function(f,d){var c=new OT.Modal(f,"<div>"+d+"</div>");OT.$.addClass(c.el,"OT_tbalert");var e=OT.$.createElement("input",{className:"OT_closeButton",type:"button",value:"close"});c.el.appendChild(e);e.onclick=function(){if(c){c.close()}c=null}};OT.$.canDefineProperty=true;try{Object.defineProperty({},"x",{})}catch(a){OT.$.canDefineProperty=false}if(!Object.create){Object.create=function(d){if(arguments.length>1){throw new Error("Object.create implementation only accepts the first parameter.")}function c(){}c.prototype=d;return new c()}}})(window);(function(a){OT.eventing=function(c){var f={};function b(h,g){if(!h){return}h.apply(null,g.slice())}function e(g,i,h,k){if(!g||g.length===0){return}var j=g.length,m=j;OT._.forEach(g,function(o,n){setTimeout(function(){try{o.apply(null,i)}finally{m--;if(m===0){b(k,i)}}},1)})}function d(g){if(f[g]){delete f[g]}}c.dispatchEvent=function(h,g){if(!h.type){OT.error("OT.Eventing.dispatchEvent: Event has no type");OT.error(h);throw new Error("OT.Eventing.dispatchEvent: Event has no type")}if(!h.target){h.target=this}if(!f[h.type]||f[h.type].length===0){b(g,[h]);return}e(f[h.type],[h],h.type,g);return this};c.trigger=function(g){if(!f[g]||f[g].length===0){return}var h=Array.prototype.slice.call(arguments);h.shift();e(f[g],h,g);return this};c.on=function(g,i){if(typeof(g)==="string"&&i){this.addEventListener(g,i)}else{for(var h in g){if(g.hasOwnProperty(h)){this.addEventListener(h,g[h])}}}return this};c.off=function(g,i){if(typeof(g)==="string"){if(i){this.removeEventListener(g,i)}else{d(g)}}else{for(var h in g){if(g.hasOwnProperty(h)){this.removeEventListener(h,g[h])}}}return this};c.addEventListener=function(g,h){if(!f[g]){f[g]=[]}f[g].push(h)};c.removeEventListener=function(g,h){if(f[g]){f[g]=OT._.without(f[g],h)}};return c};OT.eventing(OT)})(window);(function(a){OT.Event=function(e,c){this.type=e;this.cancelable=c!==undefined?c:true;var d=false,b=null;this.preventDefault=function(){if(this.cancelable){d=true}else{OT.warn("Event.preventDefault :: Trying to preventDefault on an Event that isn't cancelable")}};this.isDefaultPrevented=function(){return d};if(OT.$.canDefineProperty){Object.defineProperty(this,"target",{set:function(f){b=f},get:function(){return b}})}};OT.Event.names={ACTIVE:"active",INACTIVE:"inactive",UNKNOWN:"unknown",PER_SESSION:"perSession",PER_STREAM:"perStream",EXCEPTION:"exception",ISSUE_REPORTED:"issueReported",SESSION_CONNECTED:"sessionConnected",SESSION_DISCONNECTED:"sessionDisconnected",STREAM_CREATED:"streamCreated",STREAM_DESTROYED:"streamDestroyed",CONNECTION_CREATED:"connectionCreated",CONNECTION_DESTROYED:"connectionDestroyed",SIGNAL_RECEIVED:"signalReceived",STREAM_PROPERTY_CHANGED:"streamPropertyChanged",MICROPHONE_LEVEL_CHANGED:"microphoneLevelChanged",ARCHIVE_CREATED:"archiveCreated",ARCHIVE_CLOSED:"archiveClosed",ARCHIVE_LOADED:"archiveLoaded",ARCHIVE_SAVED:"archiveSaved",SESSION_RECORDING_STARTED:"sessionRecordingStarted",SESSION_RECORDING_STOPPED:"sessionRecordingStopped",SESSION_RECORDING_IN_PROGRESS:"sessionRecordingInProgress",STREAM_RECORDING_IN_PROGRESS:"streamRecordingInProgress",SESSION_NOT_RECORDING:"sessionNotRecording",STREAM_NOT_RECORDING:"streamNotRecording",STREAM_RECORDING_STARTED:"streamRecordingStarted",STREAM_RECORDING_STOPPED:"streamRecordingStopped",PLAYBACK_STARTED:"playbackStarted",PLAYBACK_PAUSED:"playbackPaused",PLAYBACK_STOPPED:"playbackStopped",RECORDING_STARTED:"recordingStarted",RECORDING_STOPPED:"recordingStopped",RESIZE:"resize",SETTINGS_BUTTON_CLICK:"settingsButtonClick",DEVICE_INACTIVE:"deviceInactive",INVALID_DEVICE_NAME:"invalidDeviceName",ACCESS_ALLOWED:"accessAllowed",ACCESS_DENIED:"accessDenied",ACCESS_DIALOG_OPENED:"accessDialogOpened",ACCESS_DIALOG_CLOSED:"accessDialogClosed",ECHO_CANCELLATION_MODE_CHANGED:"echoCancellationModeChanged",DEVICES_DETECTED:"devicesDetected",DEVICES_SELECTED:"devicesSelected",CLOSE_BUTTON_CLICK:"closeButtonClick",MICLEVEL:"microphoneActivityLevel",MICGAINCHANGED:"microphoneGainChanged",DYNAMIC_CONFIG_CHANGED:"dynamicConfigChanged",DYNAMIC_CONFIG_LOAD_FAILED:"dynamicConfigLoadFailed",ENV_LOADED:"envLoaded"};OT.ValueEvent=function(b,c){OT.Event.call(this,b);this.value=c};OT.ExceptionCodes={JS_EXCEPTION:2000,AUTHENTICATION_ERROR:1004,INVALID_SESSION_ID:1005,CONNECT_FAILED:1006,CONNECT_REJECTED:1007,CONNECTION_TIMEOUT:1008,P2P_CONNECTION_FAILED:1013,API_RESPONSE_FAILURE:1014,UNABLE_TO_PUBLISH:1500,UNABLE_TO_SIGNAL:1510,UNABLE_TO_FORCE_DISCONNECT:1520,UNABLE_TO_FORCE_UNPUBLISH:1530};OT.ExceptionEvent=function(c,e,f,d,b){OT.Event.call(this,c);this.message=e;this.title=f;this.code=d;this.component=b};OT.IssueReportedEvent=function(b,c){OT.Event.call(this,b);this.issueId=c};OT.EnvLoadedEvent=function(b){OT.Event.call(this,b)};OT.DynamicConfigChangedEvent=function(b){OT.Event.call(this,b)};OT.DynamicConfigLoadFailedEvent=function(b){OT.Event.call(this,b)};OT.ConnectionEvent=function(c,b,d){OT.Event.call(this,c);this.connections=b;this.reason=d};OT.StreamEvent=function(c,e,d,b){OT.Event.call(this,c,b);this.streams=e;this.reason=d};OT.SessionConnectEvent=function(d,c,e,b){OT.Event.call(this,d);this.connections=c;this.streams=e;this.archives=b;this.groups=[]};OT.SessionDisconnectEvent=function(c,d,b){OT.Event.call(this,c,b);this.reason=d};OT.VolumeEvent=function(b,d,c){OT.Event.call(this,b);this.streamId=d;this.volume=c};OT.DeviceEvent=function(c,b,d){OT.Event.call(this,c);this.camera=b;this.microphone=d};OT.DeviceStatusEvent=function(e,b,d,c,f){OT.Event.call(this,e);this.cameras=b;this.microphones=d;this.selectedCamera=c;this.selectedMicrophone=f};OT.ResizeEvent=function(c,d,b,f,e){OT.Event.call(this,c);this.widthFrom=d;this.widthTo=b;this.heightFrom=f;this.heightTo=e};OT.StreamPropertyChangedEvent=function(c,e,f,b,d){OT.Event.call(this,c);this.type=c;this.stream=e;this.changedProperty=f;this.oldValue=b;this.newValue=d};OT.ArchiveEvent=function(c,b){OT.Event.call(this,c);this.archives=b};OT.ArchiveStreamEvent=function(c,b,d){OT.Event.call(this,c);this.archive=b;this.streams=d};OT.StateChangedEvent=function(b,c){OT.Event.call(this,b);this.changedValues=c};OT.ChangeFailedEvent=function(b,e,c,d){OT.Event.call(this,b);this.reasonCode=e;this.reason=c;this.failedValues=d}})(window);(function(a){OT.Config=(function(){var j=4000,n=false,h={},c={},e,f=document.head||document.getElementsByTagName("head")[0],m,k=function(){if(m){clearTimeout(m);m=null}},b=function(){k();if(e){e.onload=e.onreadystatechange=null;if(f&&e.parentNode){f.removeChild(e)}e=undefined}},d=function(){if(e.readyState&&!/loaded|complete/.test(e.readyState)){return}k();if(!n){g._onLoadTimeout()}},i=function(o,p){if(p&&c[p]&&c[p][o]){return c[p][o]}return h[o]},g={load:function(){n=false;setTimeout(function(){e=document.createElement("script");e.async="async";e.src=OT.BUILD_PROPERTIES.configURL;e.onload=e.onreadystatechange=OT._.bind(d,this);f.appendChild(e)},1);m=setTimeout(function(){g._onLoadTimeout()},j)},_onLoadTimeout:function(){b();OT.warn("TB DynamicConfig failed to load in "+j+" ms");this.dispatchEvent(new OT.DynamicConfigLoadFailedEvent(OT.Event.names.DYNAMIC_CONFIG_LOAD_FAILED))},isLoaded:function(){return n},reset:function(){b();n=false;h={};c={}},replaceWith:function(o){b();if(!o){o={}}h=o.global||{};c=o.partners||{};if(!n){n=true}this.dispatchEvent(new OT.DynamicConfigChangedEvent(OT.Event.names.DYNAMIC_CONFIG_CHANGED))},get:function(o,q,r){var p=i(o,r);return p?p[q]:null}};OT.eventing(g);return g})()})(window);(function(a){OT.WebSocketMessageType={CONNECTED_TO_WEBSOCKET_SERVER:1000,CONNECT_TO_SESSION:1001,SIGNAL:1002,CONNECTION_CREATED:1003,CONNECTION_DESTROYED:1004,CONNECTION_COUNT_CHANGED:1005,STREAM_CREATED:1006,STREAM_MODIFIED:1007,STREAM_DESTROYED:1008,FORCE_DISCONNECT:1009,FORCE_UNPUBLISH:1010,JSEP_OFFER:1011,JSEP_ANSWER:1012,JSEP_PRANSWER:1013,JSEP_CANDIDATE:1014,JSEP_SUBSCRIBE:1015,JSEP_UNSUBSCRIBE:1016,WEBSOCKET_PING:1017,WEBSOCKET_PONG:1018,STREAM_REGISTERED:1019,SESSION_CONNECT_FAILED:1100,PUBLISH_FAILED:1101,SUBSCRIBE_FAILED:1102,FORCEDISCONNECT_FAILED:1103,FORCEUNPUBLISH_FAILED:1104}})(window);(function(a){OT.WebSocketMessage=function(b,c){this.type=b;this.payload=c;this.toString=function(){return JSON.stringify(this)}};OT.WebSocketMessage.connectToSessionMessage=function(f,e,c,d,b){return{type:OT.WebSocketMessageType.CONNECT_TO_SESSION,payload:{sessionId:f,apiKey:e,token:c,supportsWebRTC:OT.$.supportsWebRTC(),connectionObjects:d,p2pEnabled:b}}};OT.WebSocketMessage.signalMessage=function(b,d,c){return{type:OT.WebSocketMessageType.SIGNAL,payload:{fromAddress:b,toAddresses:d,messagePayload:c}}};OT.WebSocketMessage.createStream=function(g,b,c,j,i,f,d,h){var e={type:OT.WebSocketMessageType.STREAM_CREATED,payload:{publisherId:g,name:b,orientation:{videoOrientation:c,width:j,height:i},hasAudio:f,hasVideo:d,p2pEnabled:h}};return e};OT.WebSocketMessage.modifyStream=function(e,b,d){var c={type:OT.WebSocketMessageType.STREAM_MODIFIED,payload:{streamId:e,key:b,value:d}};return c};OT.WebSocketMessage.destroyStream=function(b){return{type:OT.WebSocketMessageType.STREAM_DESTROYED,payload:{streamId:b}}};OT.WebSocketMessage.jsepMessage=function(d,f,b,e){e.fromAddress=d;e.toAddresses=f;var c={type:b,payload:e};return c};OT.WebSocketMessage.forceDisconnect=function(b){return{type:OT.WebSocketMessageType.FORCE_DISCONNECT,payload:{connectionId:b}}};OT.WebSocketMessage.forceUnpublish=function(b){return{type:OT.WebSocketMessageType.FORCE_UNPUBLISH,payload:{streamId:b}}};OT.WebSocketMessage.pingMessage=function(c,b){return{type:OT.WebSocketMessageType.WEBSOCKET_PING,payload:{message:b,timestamp:(+Date.now()).toString()}}};OT.WebSocketMessage.pongMessage=function(b,c){return{type:OT.WebSocketMessageType.WEBSOCKET_PONG,payload:{message:b,timestamp:parseInt(c,10)}}}})(window);(function(a){OT.Messenger=function(n,C){var b={};b[OT.WebSocketMessageType.CONNECT_TO_SESSION]={type:"SessionConnected",afterConnected:false};b[OT.WebSocketMessageType.SESSION_CONNECT_FAILED]={type:"SessionConnectFailed",afterConnected:false};b[OT.WebSocketMessageType.CONNECTION_CREATED]={type:"ConnectionCreated",afterConnected:true};b[OT.WebSocketMessageType.CONNECTION_DESTROYED]={type:"ConnectionDestroyed",afterConnected:true};b[OT.WebSocketMessageType.STREAM_CREATED]={type:"StreamCreated",afterConnected:true};b[OT.WebSocketMessageType.STREAM_MODIFIED]={type:"StreamModified",afterConnected:true};b[OT.WebSocketMessageType.STREAM_DESTROYED]={type:"StreamDestroyed",afterConnected:true};b[OT.WebSocketMessageType.STREAM_REGISTERED]={type:"StreamRegistered",afterConnected:true};b[OT.WebSocketMessageType.JSEP_OFFER]={type:"JSEPMessageReceived",afterConnected:true};b[OT.WebSocketMessageType.JSEP_ANSWER]={type:"JSEPMessageReceived",afterConnected:true};b[OT.WebSocketMessageType.JSEP_PRANSWER]={type:"JSEPMessageReceived",afterConnected:true};b[OT.WebSocketMessageType.JSEP_CANDIDATE]={type:"JSEPMessageReceived",afterConnected:true};b[OT.WebSocketMessageType.JSEP_SUBSCRIBE]={type:"JSEPMessageReceived",afterConnected:true};b[OT.WebSocketMessageType.JSEP_UNSUBSCRIBE]={type:"JSEPMessageReceived",afterConnected:true};b[OT.WebSocketMessageType.SIGNAL]={type:"SignalReceived",afterConnected:true};var B=8081;var c=25000;var d=3*c-100;OT.eventing(this);this.onSessionConnected=null;this.onConnectionClosed=null;this.webSocket=null;this.connectionId=null;var g,h,D,A,m,w=false,t=new OT.Analytics(),y=[],v=false,f=null;var e=function(F,G,I,E){var H={action:"webSocketConnection",variation:F,payload_type:G,payload:I,session_id:g,partner_id:D.partnerId,widget_id:D.widgetId,widget_type:"Controller"};if(E){H=OT._.extend(E,H)}t.logEvent(H)};this.connect=function(H,E,F){g=H;h=E;D=F;_webSocketUrl="ws://"+n+":"+B+"/rumorwebsockets";var G=[_webSocketUrl,navigator.userAgent,OT.BUILD_PROPERTIES.version,a.externalHost?"yes":"no"];e("Attempt","webSocketServerUrl|userAgent|sdkVersion|chromeFrame",G.map(function(I){return I.replace("|","\\|")}).join("|"));this.webSocket=new WebSocket(_webSocketUrl);this.webSocket.onopen=s;this.webSocket.onclose=p;this.webSocket.onerror=z;this.webSocket.onmessage=k;A=setTimeout(function(){e("Failure","reason","Connection to the server timed out waiting to receive connected message.");q.trigger("exception","Connection to the server timed out.",OT.ExceptionCodes.CONNECTION_TIMEOUT)},15000)};this.disconnect=function(){w=true;if(this.webSocket){this.webSocket.close();this.webSocket=null}};this.sendMessage=function(E){OT.warn("Sending WebSocket message: "+JSON.stringify(E));this.webSocket.send(JSON.stringify(E))};function s(){OT.debug("WebSocket connected");clearTimeout(A);A=setTimeout(function(){e("Failure","reason","Connection to the server timed out waiting to receive connected message.");q.trigger("exception","Connection to the server timed out waiting to receive connected message.",OT.ExceptionCodes.CONNECTION_TIMEOUT)},15000)}function z(){q.trigger("exception","TB.Socket Error :: The socket to "+n+" received an error.",OT.ExceptionCodes.CONNECT_FAILED)}function p(){clearTimeout(m);q.trigger("ConnectionClosed",{reason:w?"clientDisconnected":"networkDisconnected"})}function k(E){OT.warn("WebSocket message recieved: "+E.data);x(E.data)}function x(G){var E=JSON.parse(G);switch(E.type){case OT.WebSocketMessageType.CONNECTED_TO_WEBSOCKET_SERVER:u(E.payload);break;case OT.WebSocketMessageType.WEBSOCKET_PONG:f=+Date.now();break;case OT.WebSocketMessageType.CONNECT_TO_SESSION:clearTimeout(A);v=true;o();default:if(b.hasOwnProperty(E.type)){var F=b[E.type].type;OT.debug("Received "+F);if(!v&&b[E.type].afterConnected){j(G)}else{q.trigger(F,C.wrangle(E.payload))}}else{OT.debug("Message type "+E.type+" was not handled.")}if(E.type===OT.WebSocketMessageType.CONNECT_TO_SESSION){r()}break}}function j(E){y.push(E)}function r(){while(y.length>0){x(y.shift())}}function i(){if(!f){return false}return(+Date.now()-f)>=d}function o(){if(i()){OT.error("We seem to have lost connectivity!");p()}else{q.sendMessage(OT.WebSocketMessage.pingMessage(q.connectionId,"ping!"));m=setTimeout(o,c)}}function u(E){q.connectionId=E.connectionId;e("Success","webSocketServerUrl",_webSocketUrl,{connectionId:E.connectionId});clearTimeout(A);A=setTimeout(function(){e("Failure","reason","Connection to the server timed out waiting to receive connected message.");q.trigger("exception","Connection to the server timed out fetching the session state.",OT.ExceptionCodes.CONNECTION_TIMEOUT)},15000);q.sendMessage(OT.WebSocketMessage.connectToSessionMessage(g,OT.APIKEY,h,D.requireConnectionObjects,D.p2pEnabled))}var q=this}})(window);(function(g){OT.DEBUG=5;OT.LOG=4;OT.INFO=3;OT.WARN=2;OT.ERROR=1;OT.NONE=0;var a=OT.NONE,c=[],e=false;function h(k,j,i){return function(){if(b(j)){var m=g.console;if(m&&m[k]){if(m[k].apply||Function.prototype.bind){if(!m[k].apply){m[k]=Function.prototype.bind.call(m[k],m)}m[k].apply(m,arguments)}else{m[k](Array.prototype.slice.apply(arguments).join(" "))}}else{if(i){i.apply(OT,arguments)}}d(k,arguments)}}}OT.log=h("log",OT.LOG);OT.debug=h("debug",OT.DEBUG,OT.log);OT.info=h("info",OT.INFO,OT.log);OT.warn=h("warn",OT.WARN,OT.log);OT.error=h("error",OT.ERROR,OT.log);OT.setLogLevel=function(i){a=typeof(i)==="number"?i:0;if(b(OT.DEBUG)&&!e){OT.debug("OpenTok JavaScript library "+OT.BUILD_PROPERTIES.version);OT.debug("Release notes: "+OT.BUILD_PROPERTIES.baseURL+"/opentok/webrtc/docs/js/release-notes.html");OT.debug("Known issues: "+OT.BUILD_PROPERTIES.baseURL+"/opentok/webrtc/docs/js/release-notes.html#knownIssues");e=true}OT.debug("TB.setLogLevel("+a+")");return a};OT.getLogs=function(){return c};function b(i){return a>=i}function f(){var i=new Date();return i.toLocaleTimeString()+i.getMilliseconds()}function d(m,i){if(!i){return}var j;try{j=OT.$.JSONify(i)}catch(k){j=i.toString()}if(j.length<=2){return}c.push([m,f(),j])}OT.setLogLevel(OT.BUILD_PROPERTIES.debug?OT.DEBUG:OT.ERROR)})(window);(function(a){OT.$.castToBoolean=function(c,b){if(c===undefined){return b}return c==="true"||c===true}})(window);(function(a){OT.$.supportsClassList=function(){var b=typeof(document!=="undefined")&&("classList" in document.createElement("a"));OT.$.supportsClassList=function(){return b};return b};OT.$.removeElement=function(b){if(b&&b.parentNode){b.parentNode.removeChild(b)}};OT.$.removeElementById=function(b){this.removeElement(OT.$(b))};OT.$.removeElementsByType=function(b,c){if(!b){return}var d=b.getElementsByTagName(c);while(d.length){b.removeChild(d[0])}};OT.$.emptyElement=function(b){while(b.firstChild){b.removeChild(b.firstChild)}return b};OT.$.createElement=function(h,b,g){var e=document.createElement(h);for(var d in b){if(typeof(b[d])==="object"){if(!e[d]){e[d]={}}var c=b[d];for(var f in c){e[d][f]=c[f]}}else{if(d==="className"){e.className=b[d]}else{e.setAttribute(d,b[d])}}}if(g){e.innerHTML=g}return e};OT.$.createButton=function(f,b,e){var d=OT.$.createElement("button",b,f);if(e){for(var c in e){if(e.hasOwnProperty(c)){OT.$.on(d,c,e[c])}}d._boundEvents=e}return d};OT.$.on=function(d,b,e){if(d.addEventListener){d.addEventListener(b,e,false)}else{if(d.attachEvent){d.attachEvent("on"+b,e)}else{var c=d["on"+b];d["on"+b]=function(){e.apply(this,arguments);if(c){c.apply(this,arguments)}}}}}})(window);(function(c){OT.$.addClass=function(e,f){if(e.nodeType!==1){return}var h=f.trim().split(/\s+/),d;if(OT.$.supportsClassList()){for(d=0,l=h.length;d<l;++d){e.classList.add(h[d])}return}if(!e.className&&h.length===1){e.className=f}else{var g=" "+e.className+" ";for(d=0,l=h.length;d<l;++d){if(!~g.indexOf(" "+h[d]+" ")){g+=h[d]+" "}}e.className=g.trim()}return this};OT.$.removeClass=function(e,g){if(!g){return}if(e.nodeType!==1){return}var h=g.trim().split(/\s+/),d;if(OT.$.supportsClassList()){for(d=0,l=h.length;d<l;++d){e.classList.remove(h[d])}return}var f=(" "+e.className+" ").replace(/[\s+]/," ");for(d=0,l=h.length;d<l;++d){f=f.replace(" "+h[d]+" "," ")}e.className=f.trim();return this};var a=function(d){if(d.offsetWidth>0){return d.offsetWidth+"px"}return OT.$.css(d,"width")},b=function(d){if(d.offsetHeight>0){return d.offsetHeight+"px"}return OT.$.css(d,"height")};OT.$.width=function(d){if(d.offsetWidth!==0){return a(d)}else{return OT.$.makeVisibleAndYield(d,function(){return a(d)})}};OT.$.height=function(d){if(d.offsetHeight!==0){return b(d)}else{return OT.$.makeVisibleAndYield(d,function(){return b(d)})}};OT.$.centerElement=function(e,f,d){if(!f){f=parseInt(OT.$.width(e),10)}if(!d){d=parseInt(OT.$.height(e),10)}var h=-0.5*f+"px";var g=-0.5*d+"px";OT.$.css(e,"margin",g+" 0 0 "+h);OT.$.addClass(e,"OT_centered")}})(window);(function(a){var b={};OT.$.show=function(c){var d=c.style.display;if(d===""||d==="none"){c.style.display=b[c]||"";delete b[c]}return this};OT.$.hide=function(c){if(c.style.display==="none"){return}b[c]=OT.$.css(c,"display");c.style.display="none";return this};OT.$.css=function(e,j,h){if(typeof(j)!=="string"){var g=e.style;for(var i in j){g[i]=j[i]}return this}else{if(h){e.style[j]=h;return this}else{var d=j.replace(/([A-Z]|^ms)/g,"-$1").toLowerCase(),c=e.ownerDocument.defaultView.getComputedStyle(e,null),f=c.getPropertyValue(d);if(f===""){f=e.style[d]}return f}}};OT.$.applyCSS=function(e,g,h){var f={},d,c;for(d in g){if(g.hasOwnProperty(d)){f[d]=OT.$.css(e,d);OT.$.css(e,d,g[d])}}c=h();for(d in g){if(g.hasOwnProperty(d)){OT.$.css(e,d,f[d])}}return c};OT.$.makeVisibleAndYield=function(c,d){return OT.$.applyCSS(c,{display:"block",visibility:"hidden"},d)}})(window);(function(b){function a(c){Object.defineProperty(c.prototype,"firstElementChild",{get:function(){var d=this;d=d.firstChild;while(d&&d.nodeType!=1){d=d.nextSibling}return d}});Object.defineProperty(c.prototype,"lastElementChild",{get:function(){var d=this;d=d.lastChild;while(d&&d.nodeType!=1){d=d.previousSibling}return d}});Object.defineProperty(c.prototype,"nextElementSibling",{get:function(){var d=this;while(d=d.nextSibling){if(d.nodeType==1){break}}return d}});Object.defineProperty(c.prototype,"previousElementSibling",{get:function(){var d=this;while(d=d.previousSibling){if(d.nodeType==1){break}}return d}})}OT.$.parseXML=function(e){var c,d;if(b.DOMParser){d=(new DOMParser()).parseFromString(e,"text/xml")}else{d=new ActiveXObject("Microsoft.XMLDOM");d.async="false";d.loadXML(e);a(d)}c=d.documentElement;if(!c||!c.nodeName||c.nodeName==="parsererror"){return null}return d}})(window);(function(b){function a(e,g){if(typeof(e)==="string"){return e}var f=[];for(var d in e){f.push(encodeURIComponent(d)+"="+encodeURIComponent(e[d]))}return f.join("&").replace(/\+/g,"%20")}OT.$.getXML=function(f,e){var g=e&&e.success,h=function(k){var j;if(!k){return false}j=k.documentElement;if(!j||!j.nodeName||j.nodeName==="parsererror"){return false}return true},i=function(m){var k=m.target.responseXML,j;if(h(k)){if(g){g(k,m,m.target)}}else{if(e&&e.error){e.error(m,m.target)}}};var d=OT._.extend(e.headers||{},{"Content-Type":"application/xml"});OT.$.get(f,OT._.extend(e||{},{success:i,headers:d}))};OT.$.getJSON=function(e,d){var f=d&&d.success,g=function(i){var h;try{h=JSON.parse(i.target.responseText)}catch(j){if(d&&d.error){d.error(i,i.target)}return}if(f){f(h,i,i.target)}};OT.$.get(e,OT._.extend(d||{},{success:g,headers:{"Content-Type":"application/json"}}))};OT.$.get=function(g,f){var h=new XMLHttpRequest(),d=f||{};c(h,d.success,d.error);if(d.process){h.addEventListener("progress",d.progress,false)}if(d.cancelled){h.addEventListener("abort",d.cancelled,false)}h.open("GET",g,true);if(!d.headers){d.headers={}}for(var e in d.headers){h.setRequestHeader(e,d.headers[e])}h.send()};OT.$.post=function(g,f){var h=new XMLHttpRequest(),d=f||{};c(h,d.success,d.error);if(d.process){h.addEventListener("progress",d.progress,false)}if(d.cancelled){h.addEventListener("abort",d.cancelled,false)}h.open("POST",g,true);if(!d.headers){d.headers={}}for(var e in d.headers){h.setRequestHeader(e,d.headers[e])}h.send(a(d.data))};OT.$.postFormData=function(e,g,d){if(!g){throw new Error("OT.$.postFormData must be passed a data options.")}var h=new FormData();for(var f in g){h.append(f,g[f])}OT.$.post(e,OT._.extend(d||{},{data:h}))};OT.$.getJSONP=function(e,q){var n=30000,h,j=document.head||document.getElementsByTagName("head")[0],m,i=e,p=OT._.extend(q||{},{callbackParameter:"callback"}),o=function(){if(m){clearTimeout(m);m=null}},d=function(){o();if(h){h.onload=h.onreadystatechange=null;OT.$.removeElement(h);h=undefined}},f=function(){if(h.readyState&&!/loaded|complete/.test(h.readyState)){return}o()},g=function(){d();OT.error("The JSONP request to "+i+" timed out after "+n+"ms.");if(p.error){p.error("The JSONP request to "+e+" timed out after "+n+"ms.",i,p)}},k=function(){return"jsonp_callback_"+(+new Date())};p.callbackName=k();this.jsonp_callbacks[p.callbackName]=function(r){d();if(p.success){p.success(r)}};i+=((/\?/).test(i)?"&":"?")+p.callbackParameter+"="+p.callbackName;h=OT.$.createElement("script",{async:"async",src:i,onload:f,onreadystatechange:f});j.appendChild(h);m=setTimeout(function(){_this._onLoadTimeout()},n)};var c=function(e,f,d){e.addEventListener("load",function(h){var g=h.target.status;if(g>=200&&g<300||g===304){if(f){f.apply(null,arguments)}}else{if(d){d(h)}}},false);if(d){e.addEventListener("error",d,false)}}})(window);(function(b){var a=4/3;function c(f,h,d){if(!h){h=parseInt(OT.$.width(f.parentNode),10)}else{h=parseInt(h,10)}if(!d){d=parseInt(OT.$.height(f.parentNode),10)}else{d=parseInt(d,10)}var j=(h+0)/d,i,e,g,k;if(a==j){e=i="100%"}else{if(j>a){i="100";e=(j/a)*100;k=(e-100)/2;g=0}else{e="100%";i=(a/j)*100;g=(i-100)/2;k=0}}OT.$.css(f,{width:i+"%",height:e+"%",marginLeft:"-"+g+"%",marginTop:"-"+k+"%"})}OT.$.getOrCreateWidgetContainerById=function(g,e){var d=OT.$(g),f=document.createElement("div");if(!d){d=OT.$.createElement("div",{id:g});d.style.backgroundColor="#000000";document.body.appendChild(d)}else{OT.$.emptyElement(d)}if(e){width=e.width;height=e.height;if(width){if(typeof(width)=="number"){width=width+"px"}}if(height){if(typeof(height)=="number"){height=height+"px"}}d.style.width=width?width:"264px";d.style.height=height?height:"198px";d.style.overflow="hidden";if(e.mirror===undefined||e.mirror){OT.$.addClass(d,"OT_mirrored")}}if(e.classNames){OT.$.addClass(d,e.classNames)}OT.$.addClass(f,"OT_video-container");f.style.width=d.style.width;f.style.height=d.style.height;d.appendChild(f);c(f,d.offsetWidth,d.offsetHeight);d.videoContainer=f;return d}})(window);(function(a){var b=(function(){if(navigator.getUserMedia){return navigator.getUserMedia.bind(navigator)}else{if(navigator.mozGetUserMedia){return navigator.mozGetUserMedia.bind(navigator)}else{if(navigator.webkitGetUserMedia){return navigator.webkitGetUserMedia.bind(navigator)}}}})();if(navigator.webkitGetUserMedia){if(!webkitMediaStream.prototype.getVideoTracks){webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks}}if(!webkitMediaStream.prototype.getAudioTracks){webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}}if(!webkitRTCPeerConnection.prototype.getLocalStreams){webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams}}if(!webkitRTCPeerConnection.prototype.getRemoteStreams){webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams}}}else{if(navigator.mozGetUserMedia){if(!MediaStream.prototype.getVideoTracks){MediaStream.prototype.getVideoTracks=function(){return[]}}if(!MediaStream.prototype.getAudioTracks){MediaStream.prototype.getAudioTracks=function(){return[]}}}}OT.$.supportsWebRTC=function(){var c=false;if(navigator.webkitGetUserMedia){c=typeof(webkitRTCPeerConnection)==="function"&&!!webkitRTCPeerConnection.prototype.addStream}else{if(navigator.mozGetUserMedia){var d=a.navigator.userAgent.toLowerCase().match(/Firefox\/([0-9\.]+)/i);c=typeof(mozRTCPeerConnection)==="function"&&(d!==null&&parseFloat(d[1],10)>20);if(c){try{new mozRTCPeerConnection();c=true}catch(e){c=false}}}}OT.$.supportsWebRTC=function(){return c};return c};OT.$.supportedCryptoScheme=function(){if(!OT.$.supportsWebRTC()){return"NONE"}var c=a.navigator.userAgent.toLowerCase().match(/chrome\/([0-9\.]+)/i);return c&&parseFloat(c[1],10)<25?"SDES_SRTP":"DTLS_SRTP"};OT.$.getUserMedia=function(i,n,f,d,c){if(!i||OT._.all(i,function(e){return e===false})){OT.error("Couldn't get UserMedia: All constraints were false");f({code:"NO_CONSTRAINTS"});return}var g=null,h=function(){if(g){clearTimeout(g)}else{if(c){c()}}},o=function(){g=null;if(d){d()}},m=function(){h();n.apply(null,arguments)},j=function(e){h();f.apply(null,arguments)};try{b(i,m,j)}catch(k){OT.error("Couldn't get UserMedia: "+k.toString());j({})}if(location.protocol.indexOf("https")===-1){setTimeout(o,100)}else{g=setTimeout(o,500)}}})(window);(function(a){OT.Modal=function(e,b,d){var c="        <header>            <h1><%= title %></h1>        </header>        <div class='OT_dialog-body'>            <%= body %>        </div>    ";this.el=OT.$.createElement("section",{className:"OT_root OT_dialog OT_modal"},OT._.template(c,{title:e,body:b}));this.el.style.display="none";document.body.appendChild(this.el);OT.$.centerElement(this.el);OT.$.show(this.el);this.close=function(){OT.$.removeElement(this.el);this.el=null;return this}}})(window);(function(c){function b(){var d=false,f=false,i=function(){return f&&d},g=function(){if(i()){OT.dispatchEvent(new OT.EnvLoadedEvent(OT.Event.names.ENV_LOADED))}},j=function(){f=true;OT.Config.load();g()},e=function(){d=true;OT.Config.off(OT.Event.names.DYNAMIC_CONFIG_CHANGED,e);OT.Config.off(OT.Event.names.DYNAMIC_CONFIG_LOAD_FAILED,h);g()},h=function(){e()};OT.Config.on(OT.Event.names.DYNAMIC_CONFIG_CHANGED,e);OT.Config.on(OT.Event.names.DYNAMIC_CONFIG_LOAD_FAILED,h);if(document.readyState=="complete"||(document.readyState=="interactive"&&document.body)){j()}else{if(document.addEventListener){document.addEventListener("DOMContentLoaded",j,false)}else{if(document.attachEvent){document.attachEvent("onreadystatechange",function(){if(document.readyState=="complete"){j()}})}}}this.onLoad=function(k){if(i()){k();return}OT.on(OT.Event.names.ENV_LOADED,k)}}var a=new b();OT.onLoad=function(d,e){if(!e){a.onLoad(d)}else{a.onLoad(OT._.bind(d,e))}}})(window);(function(d){var c={1000:"Failed To Load",1004:"Authentication error",1005:"Invalid Session ID",1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1012:"Peer-to-peer Stream Play Failed",1013:"Peer-to-peer Connection Failed",1014:"API Response Failure",1500:"Unable to Publish",1510:"Unable to Signal",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",1540:"Unable to record archive",1550:"Unable to play back archive",1560:"Unable to create archive",1570:"Unable to load archive",2000:"Internal Error",2001:"Embed Failed",3000:"Archive load exception",3001:"Archive create exception",3002:"Playback stop exception",3003:"Playback start exception",3004:"Record start exception",3005:"Record stop exception",3006:"Archive load exception",3007:"Session recording in progress",3008:"Archive recording internal failure",4000:"WebSocket Connection Failed",4001:"WebSocket Network Disconnected"};var b;function a(e,k,i,f){var j=c[i],g=f?OT._.clone(f):{};OT.error("TB.exception :: title: "+j+" ("+i+") msg: "+k);if(!g.partnerId){g.partnerId=OT.APIKEY}try{if(!b){b=new OT.Analytics()}b.logError(i,"tb.exception",j,{details:k},g);OT.dispatchEvent(new OT.ExceptionEvent(OT.Event.names.EXCEPTION,k,j,i,e))}catch(h){OT.error("TB.exception :: Failed to dispatch exception - "+h.toString())}}OT.handleJsException=function(h,g,e){if(e&&!e.target){e.target=null}var f,i=e.session;if(i){f={sessionId:i.sessionId};if(i.connected){f.connectionId=i.connection.connectionId}}else{if(e.sessionId){f={sessionId:e.sessionId}}}a(e.target,h,g,f)};OT.exceptionHandler=function(f,j,e,i,g){var h;if(f){h=OT.components[f];if(!h){OT.warn("Could not find the component with component ID "+f)}}a(h,j,i,g)}})(window);(function(a){OT.ConnectionCapabilities=function(d){var b=function(e){e.supportsWebRTC=OT.$.castToBoolean(e.supportsWebRTC);return e};var c=b(d);this.supportsWebRTC=c.supportsWebRTC}})(window);(function(a){OT.Connection=function(e,b,d,c){this.id=this.connectionId=e;this.creationTime=Number(b);this.data=d;this.capabilities=new OT.ConnectionCapabilities(c);this.quality=null;OT.eventing(this)}})(window);(function(a){OT.Stream=function(e,f,b,j,n,k,m,h,d,i,g,o,c,p){this.id=this.streamId=e;this.sessionId=i;this.connection=f;this.name=b;this.data=j;this.type=n||"basic";this.creationTime=Number(k);this.hasAudio=OT.$.castToBoolean(m,true);this.hasVideo=OT.$.castToBoolean(h,true);this.orientation=d;this.peerId=g;this.quality=o;this.videoDimensions={width:c,height:p};OT.eventing(this);this.update=function(q,r){switch(q){case"hasAudio":case"hasVideo":this[q]=OT.$.castToBoolean(r,true);break;case"quality":case"name":case"videoDimensions":case"orientation":this[q]=r}};this.startRecording=function(q){OT.debug("OT.Stream.startRecording");throw new Error("OT.Stream.startRecording: Is not implemented yet.")};this.stopRecording=function(q){OT.debug("OT.Stream.stopRecording");throw new Error("OT.Stream.stopRecording: Is not implemented yet.")}}})(window);(function(a){OT.DOMComponentCleanup=(function(){var e={},d={};var c=function(f){OT.$.on(f,"unload",function(){return b(f)})},b=function(f){if(!d[f]||d[f].length===0){return}d[f].slice().forEach(function(g){g.destroy()});delete d[f]};return{add:function(f){if(f.targetElement&&f.id){var g=f.targetElement.ownerDocument.defaultView;e[f.id]=g;if(!d.hasOwnProperty(g)){d[g]=[];c(g)}d[g].push(f)}},remove:function(g){if(!g.id||!e[g.id]){return}var h=e[g.id],f;if((f=OT._.indexOf(d[h],g))!=-1){d[h].splice(f,1)}}}})()})(window);(function(c){OT.VideoOrientation={ROTATED_NORMAL:"OTVideoOrientationRotatedNormal",ROTATED_LEFT:"OTVideoOrientationRotatedLeft",ROTATED_RIGHT:"OTVideoOrientationRotatedRight",ROTATED_UPSIDE_DOWN:"OTVideoOrientationRotatedUpsideDown"};OT.rtc.VideoElement=function(p){var i,n,j,g=false,o=OT._.defaults(p||{},{fallbackText:"Sorry, Web RTC is not available in your browser"});OT.eventing(this);var k=OT._.bind(function(q){var r="There was an unexpected problem with the Video Stream: "+b(q.target.error.code);this.trigger("error",null,r,this)},this),h=OT._.bind(function(){g=true;this.trigger("streamBound",this)},this),m=OT._.bind(function(q){this.trigger("error",OT.ExceptionCodes.P2P_CONNECTION_FAILED,q,this)},this);n=d(o.fallbackText,o.attributes);n.addEventListener("error",k,false);Object.defineProperties(this,{stream:{get:function(){return i}},domElement:{get:function(){return n}},parentElement:{get:function(){return j}},isBoundToStream:{get:function(){return g}}});this.appendTo=function(q){j=q;j.appendChild(n);return this};this.bindToStream=function(q){g=false;i=q;a(n,i,h,m);return this};this.unbindStream=function(){if(!i){return}if(n){if(!navigator.mozGetUserMedia){c.URL.revokeObjectURL(n.src)}else{n.mozSrcObject=null}}i=null;return this};this.destroy=function(){this.unbindStream();if(n){OT.$.removeElement(n);n=null}j=null;return undefined}};if(OT.$.canDefineProperty){Object.defineProperty(OT.rtc.VideoElement.prototype,"imgData",{get:function(){var g=OT.$.createElement("canvas",{width:this.domElement.videoWidth,height:this.domElement.videoHeight,style:{display:"none"}});document.body.appendChild(g);g.getContext("2d").drawImage(this.domElement,0,0,g.width,g.height);var h=g.toDataURL("image/png");OT.$.removeElement(g);return h.replace("data:image/png;base64,","").trim()}})}var f={OTVideoOrientationRotatedNormal:"rotate(0deg)",OTVideoOrientationRotatedLeft:"rotate(90deg)",OTVideoOrientationRotatedRight:"rotate(-90deg)",OTVideoOrientationRotatedUpsideDown:"rotate(180deg)"};if(OT.$.canDefineProperty){Object.defineProperty(OT.rtc.VideoElement.prototype,"orientation",{set:function(g){var h=f[g]||f.ROTATED_NORMAL;switch(OT.$.browser()){case"Chrome":case"Safari":this.domElement.style.webkitTransform=h;break;case"IE":this.domElement.style.msTransform=h;break;default:this.domElement.style.transform=h}}})}function d(j,g){var i=document.createElement("video");i.setAttribute("autoplay","");i.innerHTML=j;if(g){if(g.muted===true){delete g.muted;i.muted="true"}for(var h in g){i.setAttribute(h,g[h])}}return i}var e={};if(c.MediaError){e[c.MediaError.MEDIA_ERR_ABORTED]="The fetching process for the media resource was aborted by the user agent at the user's request.";e[c.MediaError.MEDIA_ERR_NETWORK]="A network error of some description caused the user agent to stop fetching the media resource, after the resource was established to be usable.";e[c.MediaError.MEDIA_ERR_DECODE]="An error of some description occurred while decoding the media resource, after the resource was established to be usable.";e[c.MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]="The media resource indicated by the src attribute was not suitable. "}function b(g){return e[parseInt(g,10)]||"An unknown error occurred."}function a(m,g,j,o){if(navigator.mozGetUserMedia){m.mozSrcObject=g}else{m.src=c.URL.createObjectURL(g)}m.play();var i=150,h=0,n;(function k(){h++;if((!navigator.mozGetUserMedia&&g.getVideoTracks().length===0&&g.getAudioTracks().length===0)||m.currentTime>0){j()}else{if(h<i){n=setTimeout(k,200)}else{o("The video stream failed to connect. Please notify the site owner if this continues to happen.")}}})()}})(window);(function(f){var g=(f.webkitRTCPeerConnection||f.mozRTCPeerConnection);var e=(f.mozRTCSessionDescription||f.RTCSessionDescription);var d=(f.mozRTCIceCandidate||f.RTCIceCandidate);var c=function(i,j){return function(k){OT.debug("IceCandidateForwarder: Ice Candidate");if(k.candidate){i(OT.WebSocketMessageType.JSEP_CANDIDATE,{candidate:k.candidate})}else{OT.debug("IceCandidateForwarder: No more ICE candidates. PeerConnection Status: "+k.srcElement.readyState+", Ice Status: "+k.srcElement.iceState);j()}}};var a=function(){var j=[],i=null;Object.defineProperty(this,"peerConnection",{set:function(k){i=k}});this.process=function(m){var k=new d(m.candidate);if(i){i.addIceCandidate(k)}else{j.push(k)}};this.processPending=function(){while(j.length){i.addIceCandidate(j.shift())}}};var b=function(i,o,p,j){var n=function(r){return function(s){if(j){j(r,s)}}},m=function(r){i.setLocalDescription(r,function(){p(r)},n("Error while setting LocalDescription"))},k=function(r){i.createAnswer(m,n("Error while setting createAnswer"),null,false)};if(o.sdp.indexOf("a=crypto")===-1){var q="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\\r\\n";o.sdp=o.sdp.replace(/^c=IN(.*)$/gmi,"c=IN$1\r\n"+q)}i.setRemoteDescription(o,k,n("Error while setting RemoteDescription"))};var h=function(i,n,j){var o={mandatory:{},optional:[]},m=function(p){return function(q){if(j){j(p,q)}}},k=function(p){i.setLocalDescription(p,function(){n(p)},m("Error while setting LocalDescription"))};if(navigator.mozGetUserMedia){o.mandatory.MozDontOfferDataChannel=true}i.createOffer(k,m("Error while creating Offer"),o)};OT.rtc.PeerConnection=function(B){var n,j=new a(),t,D,x="new",r=false,w=[];OT.eventing(this);if(navigator.mozGetUserMedia){B.iceServers=[]}var y=OT._.bind(function(E,F){if(w.length){w[0](E,F)}},this),u=OT._.bind(function(){if(!n){try{OT.debug('Creating peer connection config "'+JSON.stringify(B)+'".');n=new g(B,{optional:[{DtlsSrtpKeyAgreement:true}]})}catch(E){OT.error("Failed to create PeerConnection, exception: "+E.message);return null}j.peerConnection=n;n.onicecandidate=c(y,OT._.bind(function(){this.trigger("open")},this));n.onaddstream=OT._.bind(C,this);n.onremovestream=OT._.bind(o,this);if(n.onsignalingstatechange!==undefined){n.onsignalingstatechange=OT._.bind(m,this)}else{if(n.onstatechange!==undefined){n.onstatechange=OT._.bind(m,this)}}}return n},this),m=function(E){var F=(E.target.signalingState||E.target.readyState);if(F&&F.toLowerCase()!==x){x=F.toLowerCase();OT.debug("PeerConnection.stateChange: "+x);switch(x){case"closed":if(j){j.peerConnection=null}n=null;this.trigger("close");break}}},q=function(){var E;if(n.getLocalStreams){E=n.getLocalStreams()}else{if(n.localStreams){E=n.localStreams}else{throw new Error("Invalid Peer Connection object implements no method for retrieving local streams")}}return Array.prototype.slice.call(E)},v=function(){var E;if(n.getRemoteStreams){E=n.getRemoteStreams()}else{if(n.remoteStreams){E=n.remoteStreams}else{throw new Error("Invalid Peer Connection object implements no method for retrieving remote streams")}}return Array.prototype.slice.call(E)},p=function(F,E){return OT._.bind(function(G){i.call(this,"PeerConnection."+F+": "+E+": "+G)},this)},C=function(F){var E=(F.type==="audio"||F.type==="video")?F.type:"merged";this.trigger("streamAdded",F.stream,E)},o=function(F){var E=(F.type==="audio"||F.type==="video")?F.type:"merged";this.trigger("streamRemoved",F.stream,E)},A=function(F,E){y(F,{sdp:E})},s=function(G){var F=new e(G.sdp),E=function(I){A(OT.WebSocketMessageType.JSEP_ANSWER,I)},H=function(J,I){i("PeerConnection.offerProcessor "+J+": "+I)};u();_remoteDescriptionType=F.type;_remoteDescription=F;b(n,F,E,H)},z=function(E){if(!E.sdp){OT.error("PeerConnection.processMessage: Weird message, no SDP.");return}D=new e(E.sdp);_remoteDescriptionType=D.type;_remoteDescription=D;n.setRemoteDescription(D);j.processPending()},k=function(E){OT.debug("PeerConnection.processSubscribe: Sending offer to subscriber.");u();h(n,function(F){t=F;A(OT.WebSocketMessageType.JSEP_OFFER,t)},function(G,F){i("PeerConnection.suscribeProcessor "+G+": "+F)})},i=OT._.bind(function(E){OT.error(E);this.trigger("error",E)},this);this.addLocalStream=function(E){u();n.addStream(E)};this.disconnect=function(){j=null;if(n){var E=(n.signalingState||n.readyState);if(E&&E.toLowerCase()!=="closed"){n.close()}n=null}};this.processMessage=function(E,F){OT.debug("PeerConnection.processMessage: Received "+E+" from "+F.fromAddress);OT.debug(F);switch(E){case OT.WebSocketMessageType.JSEP_SUBSCRIBE:k.call(this,F);break;case OT.WebSocketMessageType.JSEP_OFFER:s.call(this,F);break;case OT.WebSocketMessageType.JSEP_ANSWER:z.call(this,F);break;case OT.WebSocketMessageType.JSEP_CANDIDATE:j.process(F);break;default:OT.debug("PeerConnection.processMessage: Received an unexpected message of type "+E+" from "+F.fromAddress+": "+JSON.stringify(F))}return this};this.registerMessageDelegate=function(E){w.push(E)};this.unregisterMessageDelegate=function(E){OT._.without(w,E)};Object.defineProperty(this,"remoteStreams",{get:function(){return n?v():[]}})}})(window);(function(b){var a={};OT.rtc.PeerConnections={add:function(g,f,c){var d=g.id+"_"+f.id,e=a[d];if(!e){e=a[d]={count:0,pc:new OT.rtc.PeerConnection(c)}}e.count+=1;return e.pc},remove:function(f,e){var c=f.id+"_"+e.id,d=a[c];if(d){d.count-=1;if(d.count===0){d.pc.disconnect();delete a[c]}}}}})(window);(function(a){OT.rtc.PublisherPeerConnection=function(m,f,i,k){var j,b=false;var c=function(){this.trigger("connected",this)},e=function(){this.destroy();this.trigger("disconnected",this)},h=function(n){this.trigger("error",null,n,this);this.destroy()},g=function(n,o){if(!b&&n===OT.WebSocketMessageType.JSEP_CANDIDATE){b=o.candidate.candidate.indexOf("relay")!==-1}f.sendJSEPMessage(m,n,OT._.extend(o,{streamId:i.id}))};OT.eventing(this);this.destroy=function(){if(j){OT.rtc.PeerConnections.remove(m,i)}j=null};this.processMessage=function(n,o){j.processMessage(n,o)};var d;if(f.sessionInfo.iceServers){d=f.sessionInfo.iceServers}else{d=[{url:"stun:stun.l.google.com:19302"}]}j=OT.rtc.PeerConnections.add(m,i,{iceServers:d});j.on({open:OT._.bind(c,this),close:OT._.bind(e,this),error:OT._.bind(h,this)});j.registerMessageDelegate(g);j.addLocalStream(k);Object.defineProperty(this,"remoteConnection",{value:m});Object.defineProperty(this,"hasRelayCandidates",{get:function(){return b}})}})(window);(function(a){OT.rtc.SubscriberPeerConnection=function(q,j,n){var p,o={},h=false,d=false;var e=function(){h=true;this.trigger("connected",this)},g=function(){h=false;this.destroy();this.trigger("disconnected",this)},c=function(r,s){o[s]=r;this.trigger("remoteStreamAdded",o[s],s,this)},i=function(r,s){delete o[s];this.trigger("remoteStreamRemoved",r,s,this)},m=function(r){h=false;this.trigger("error",null,r,this)},k=function(r,s){if(!d&&r===OT.WebSocketMessageType.JSEP_CANDIDATE){d=s.candidate.candidate.indexOf("relay")!==-1}j.sendJSEPMessage(q,r,OT._.extend(s,{streamId:n.id}))},b=function(r){var s="get"+(r?"Video":"Audio")+"Tracks";return function(x){var z=p.remoteStreams,w,A;if(z.length===0||!z[0][s]){return}for(var y=0,v=z.length;y<v;++y){A=z[y];w=A[s]();for(var t=0,u=w.length;t<u;++t){w[t].enabled=x}}}};OT.eventing(this);this.destroy=function(){if(j&&j.connected&&n){j.sendJSEPMessage(n.connection,OT.WebSocketMessageType.JSEP_UNSUBSCRIBE,{streamId:n.id})}if(p){this.subscribeToAudio(false);OT.rtc.PeerConnections.remove(q,n)}o={};h=false;p=null};this.processMessage=function(r,s){p.processMessage(r,s)};this.subscribeToAudio=b(false);this.subscribeToVideo=b(true);Object.defineProperty(this,"connected",{get:function(){return h}});Object.defineProperty(this,"hasRelayCandidates",{get:function(){return d}});var f;if(j.sessionInfo.iceServers){f=j.sessionInfo.iceServers}else{f=[{url:"stun:stun.l.google.com:19302"}]}p=OT.rtc.PeerConnections.add(q,n,{iceServers:f});p.on({open:OT._.bind(e,this),close:OT._.bind(g,this),streamAdded:OT._.bind(c,this),streamRemoved:OT._.bind(i,this),error:OT._.bind(m,this)});p.registerMessageDelegate(k);if(p.remoteStreams.length>0){p.remoteStreams.forEach(c,this)}else{j.sendJSEPMessage(q,OT.WebSocketMessageType.JSEP_SUBSCRIBE,{streamId:n.id,keyManagemenMethod:OT.$.supportedCryptoScheme()})}}})(window);(function(a){OT.Chrome=function(d){var e=false,c={},b=function(f,g){g.parent=this;g.appendTo(d.parent);c[f]=g;Object.defineProperty(this,f,{get:function(){return c[f]}})};if(!d.parent){return}OT.eventing(this);this.destroy=function(){this.hide();for(var f in c){c[f].destroy()}};this.show=function(){e=true;for(var f in c){c[f].show()}};this.hide=function(){e=false;for(var f in c){c[f].hide()}};this.set=function(g,h){if(typeof(g)==="string"&&h){b.call(this,g,h)}else{for(var f in g){if(g.hasOwnProperty(f)){b.call(this,f,g[f])}}}return this}}})(window);(function(a){if(!OT.Chrome.Behaviour){OT.Chrome.Behaviour={}}OT.Chrome.Behaviour.Widget=function(f,c){var b=c||{},e,d;f.setDisplayMode=function(h){var g=h||"auto";if(e===g){return}OT.$.removeClass(this.domElement,"OT_mode-"+e);OT.$.addClass(this.domElement,"OT_mode-"+g);d=e;e=g};f.show=function(){this.setDisplayMode(d);if(b.onShow){b.onShow()}return this};f.hide=function(){this.setDisplayMode("off");if(b.onHide){b.onHide()}return this};f.destroy=function(){if(b.onDestroy){b.onDestroy(this.domElement)}if(this.domElement){OT.$.removeElement(this.domElement)}return f};f.appendTo=function(g){this.domElement=OT.$.createElement(b.nodeName||"div",b.htmlAttributes,b.htmlContent);if(b.onCreate){b.onCreate(this.domElement)}f.setDisplayMode("on");g.appendChild(this.domElement);setTimeout(function(){f.setDisplayMode(b.mode)},2000);return f}}})(window);(function(a){OT.Chrome.NamePanel=function(c){var b=c.name;if(!b||b.trim().length===""){b=null;c.mode="off"}var d;this.__defineGetter__("domElement",function(){return d});this.__defineSetter__("domElement",function(e){d=e});OT.Chrome.Behaviour.Widget(this,{mode:c.mode,nodeName:"h1",htmlContent:b,htmlAttributes:{className:"OT_name"}});this.__defineSetter__("name",OT._.bind(function(e){if(!b){this.setDisplayMode("auto")}b=e;d.innerHTML=b},this))}})(window);(function(a){OT.Chrome.MuteButton=function(d){var f,c=d.muted||false;var g;this.__defineGetter__("domElement",function(){return g});this.__defineSetter__("domElement",function(j){g=j});var e=function(j){f=OT._.bind(i,this);j.addEventListener("click",f,false)},b=function(j){f=null;j.removeEventListener("click",f,false)},i=function(j){c=!c;if(c){OT.$.addClass(g,"OT_active");this.parent.trigger("muted",this)}else{OT.$.removeClass(g,"OT_active");this.parent.trigger("unmuted",this)}return false};var h=c?"OT_mute OT_active":"OT_mute";OT.Chrome.Behaviour.Widget(this,{mode:d.mode,nodeName:"button",htmlContent:"Mute",htmlAttributes:{className:h},onCreate:OT._.bind(e,this),onDestroy:OT._.bind(b,this)})}})(window);(function(a){OT.Chrome.MicVolume=function(d){var f,c=d.muted||false;var g;this.__defineGetter__("domElement",function(){return g});this.__defineSetter__("domElement",function(i){g=i});var e=function(i){f=OT._.bind(h,this);i.addEventListener("click",f,false)},b=function(i){f=null;i.removeEventListener("click",f,false)},h=function(i){c=!c;if(c){OT.$.addClass(g,"active");this.parent.trigger("muted",this)}else{OT.$.removeClass(g,"active");this.parent.trigger("unmuted",this)}return false};OT.Chrome.Behaviour.Widget(this,{mode:d.mode,nodeName:"button",htmlContent:"Mute",htmlAttributes:{className:"OT_mic-volume"},onCreate:OT._.bind(e,this),onDestroy:OT._.bind(b,this)})}})(window);(function(a){OT.Chrome.SettingsPanelButton=function(c){var e;var d=function(h){e=OT._.bind(g,this);h.addEventListener("click",e,false)},b=function(h){e=null;h.removeEventListener("click",e,false)},g=function(h){this.parent.trigger("SettingsPanel:open",this);return false};var f;this.__defineGetter__("domElement",function(){return f});this.__defineSetter__("domElement",function(h){f=h});OT.Chrome.Behaviour.Widget(this,{mode:c.mode,nodeName:"button",htmlContent:"Settings",htmlAttributes:{className:"OT_settings-panel"},onCreate:OT._.bind(d,this),onDestroy:OT._.bind(b,this)})}})(window);(function(a){OT.Chrome.SettingsPanel=function(e){if(!e.stream){return}var d=e.stream;var f;this.__defineGetter__("domElement",function(){return f});this.__defineSetter__("domElement",function(h){f=h});var c=function(){var j=d.getVideoTracks().length?d.getVideoTracks()[0].label:"None",i=d.getAudioTracks().length?d.getAudioTracks()[0].label:"None";f.innerHTML="<dl>                                        <dt>Cam</dt>                                        <dd>"+j+"</dd>                                        <dt>Mic</dt>                                        <dd>"+i+"</dd>                                    </dl>";var h=OT.$.createButton("Close",{className:"OT_close"},{click:OT._.bind(b,this)});f.appendChild(h)},g=function(){c.call(this)},b=function(){this.parent.trigger("SettingsPanel:close",this);return false};OT.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"section",htmlContent:"Settings",htmlAttributes:{className:"OT_settings-panel"},onCreate:OT._.bind(c,this),onShow:OT._.bind(g,this)})}})(window);(function(a){OT.Chrome.OpenTokButton=function(b){if(!b||!b.infoHref){return false}var c;this.__defineGetter__("domElement",function(){return c});this.__defineSetter__("domElement",function(d){c=d});OT.Chrome.Behaviour.Widget(this,{mode:b?b.mode:null,nodeName:"a",htmlContent:"OpenTok",htmlAttributes:{className:"OT_opentok",title:"more info",href:b.infoHref,target:"_blank"}});this.__defineSetter__("infoHref",function(d){b.infoHref=d;c.setAttribute("href",d)})}})(window);(function(b){OT.rtc.StylableComponent=function(f,d){if(!f.trigger){throw new Error("OT.rtc.StylableComponent is dependent on the mixin OT.eventing. Ensure that this is included in the object before StylableComponent.")}var e=function(h,i,g){if(g){f.trigger("styleValueChanged",h,i,g)}else{f.trigger("styleValueChanged",h,i)}};var c=new a(d,e);f.getStyle=function(g){return c.get(g)};f.setStyle=function(i,h,g){if(typeof(i)!=="string"){c.setAll(i,g)}else{c.set(i,h)}return this}};var a=function(d,f){var e=["showMicButton","showSpeakerButton","showSettingsButton","showCameraToggleButton","nameDisplayMode","buttonDisplayMode","showSaveButton","showRecordButton","showRecordStopButton","showReRecordButton","showPauseButton","showPlayButton","showPlayStopButton","showStopButton","backgroundImageURI","showControlPanel","showRecordCounter","showPlayCounter","showControlBar","showPreviewTime"],i={buttonDisplayMode:["auto","off","on"],nameDisplayMode:["auto","off","on"],showSettingsButton:[true,false],showMicButton:[true,false],showCameraToggleButton:[true,false],showSaveButton:[true,false],backgroundImageURI:null,showControlBar:[true,false],showPlayCounter:[true,false],showRecordCounter:[true,false],showPreviewTime:[true,false]},c={},g=function(j,k){return j==="backgroundImageURI"||(i.hasOwnProperty(j)&&OT._.include(i[j],k))},h=function(j){switch(j){case"true":return true;case"false":return false;default:return j}};this.getAll=function(){var k=OT._.clone(c);for(var j in k){if(e.indexOf(j)<0){delete k[j]}}return k};this.get=function(j){if(j){return c[j]}return this.getAll()};this.setAll=function(n,j){var k,o;for(var m in n){o=h(n[m]);if(g(m,o)){k=c[m];if(o!==k){c[m]=o;if(!j){f(m,o,k)}}}else{OT.warn("Style.setAll::Invalid style property passed "+m+" : "+o)}}return this};this.set=function(k,m){OT.debug("Publisher.setStyle: "+k.toString());var n=h(m),j;if(!g(k,n)){OT.warn("Style.set::Invalid style property passed "+k+" : "+n);return this}j=c[k];if(n!==j){c[k]=n;f(k,m,j)}return this};if(d){this.setAll(d,true)}}})(window);(function(a){OT.Microphone=function(c,e){var b,d=50;Object.defineProperty(this,"muted",{get:function(){return b},set:function(h){if(b===h){return}b=h;var j=c.getAudioTracks();for(var g=0,f=j.length;g<f;++g){j[g].enabled=!b}}});Object.defineProperty(this,"gain",{get:function(){return d},set:function(f){OT.warn("OT.Microphone.gain IS NOT YET IMPLEMENTED");d=f}});if(e!==undefined){this.muted=e===true}else{if(c.getAudioTracks().length){this.muted=!c.getAudioTracks()[0].enabled}else{this.muted=false}}}})(window);(function(a){OT.rtc.Publisher=function(){if(!OT.checkSystemRequirements()){OT.upgradeSystemRequirements();return}var j=OT.rtc.Publisher.nextId(),A,n,v,t,r,F,p={},e=false,w,h,d=false,E,G,x=new OT.Analytics(),g;OT.eventing(this);OT.rtc.StylableComponent(this,{showMicButton:true,showSettingsButton:true,showCameraToggleButton:true,nameDisplayMode:"auto",buttonDisplayMode:"auto",backgroundImageURI:null});var f=function(J,H,I,K){x.logEvent({action:J,variation:H,payload_type:I,payload:K,session_id:F?F.sessionId:null,connection_id:F&&F.connected?F.connection.connectionId:null,partner_id:F?F.apiKey:OT.APIKEY,streamId:t?t.id:null,widget_id:j,widget_type:"Publisher"})},b=function(){OT.debug("OT.rtc.Publisher.onLoaded");f("publish","Success","streamType","WebRTC");OT.$.removeClass(n,"loading");u.call(this);e=true;this.trigger("loaded",this)},c=function(H){f("publish","Failure","reason","Publisher PeerConnection Error: "+H);OT.handleJsException("Publisher PeerConnection Error: "+H,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:F,target:this})},C=function(H){OT.debug("OT.rtc.Publisher.onStreamAvailable");this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_ALLOWED,false));i();r=H;E=new OT.Microphone(r,!w.publishAudio);this.publishVideo(w.publishVideo);v=new OT.rtc.VideoElement({attributes:{muted:true}});v.on({streamBound:OT._.bind(b,this),timeout:OT._.bind(c,this),error:OT._.bind(o,this)}).bindToStream(r).appendTo(n.videoContainer);OT.DOMComponentCleanup.add(this,v)},z=function(H){var J=function(M,L){OT.error("OT.rtc.Publisher.onStreamAvailableError "+M);f("publish","Failure","reason","Publisher failed to access camera/mic: "+M);OT.handleJsException("Publisher failed to access camera/mic: "+M,2000,{session:F,target:L})};switch(H.code){case 1:OT.error("OT.rtc.Publisher.onStreamAvailableError Permission Denied");f("publish","Failure","reason","Publisher Access Denied: Permission Denied ("+H.code+")");var K=new OT.Event(OT.Event.names.ACCESS_DENIED),I=function(){if(!K.isDefaultPrevented()&&n){OT.$.removeElement(n)}};this.dispatchEvent(K,I);break;case"NO_CONSTRAINTS":if(n){OT.$.removeElement(n)}J("No constaints were provided",this);break;default:if(n){OT.$.removeElement(n)}J("Unknown Reason ("+H.code+")",this)}},m=function(){f("accessDialog","Opened","","");this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_OPENED,false))},s=function(){f("accessDialog","Closed","","");this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_CLOSED,false))},o=function(J,H){OT.error("OT.rtc.Publisher.onVideoError");var I=H+(J?" ("+J+")":"");f("stream",null,"reason","Publisher while playing stream: "+I);OT.handleJsException("Publisher error playing stream: "+I,2000,{session:F,target:this})},k=function(H){OT.debug("OT.rtc.Subscriber has been disconnected from the Publisher's PeerConnection");this.cleanupSubscriber(H.remoteConnection.id)},y=function(I,J,H){f("publish","Failure","reason|hasRelayCandidates",["Publisher PeerConnection with connection "+H.remoteConnection.id+" failed: "+J,H.hasRelayCandidates].join("|"));OT.handleJsException("Publisher PeerConnection Error: "+J,2000,{session:F,target:this});delete p[H.remoteConnection.id]},i=function(){if(r){r.stop();r=null}},B=function(J){var H=p[J.id];if(!H){var I=OT.$.now();f("createPeerConnection","Attempt","","");H=p[J.id]=new OT.rtc.PublisherPeerConnection(J,F,t,r);H.on({connected:function(){f("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(OT.$.now()-I,10),H.hasRelayCandidates].join("|"))},disconnected:OT._.bind(k,this),error:OT._.bind(y,this)})}return H},D=function(I){if(I===false){return"off"}var H=this.getStyle("buttonDisplayMode");if(H===false){return"on"}return H},q=function(I,J,H){if(!G){return}switch(I){case"nameDisplayMode":G.name.setDisplayMode(J);break;case"buttonDisplayMode":case"showMicButton":case"showSettingsButton":}},u=function(){G=new OT.Chrome({parent:n}).set({name:new OT.Chrome.NamePanel({name:w.name,mode:this.getStyle("nameDisplayMode")}),muteButton:new OT.Chrome.MuteButton({muted:w.publishAudio===false,mode:D.call(this,this.getStyle("showMicButton"))}),opentokButton:new OT.Chrome.OpenTokButton({infoHref:OT.$.moreInfoLink(F)})}).on({muted:OT._.bind(function(){this.publishAudio(false)},this),unmuted:OT._.bind(function(){this.publishAudio(true)},this)})};this.publish=function(I,H){OT.debug("OT.rtc.Publisher: publish");if(A){this.unpublish()}A=I||uuid();w=OT._.defaults(H||{},{publishAudio:true,publishVideo:true,mirror:true});if(w.style){this.setStyle(w.style,null,true)}if(w.name){w.name=w.name.toString()}w.classNames="OT_root OT_publisher OT_loading";OT.onLoad(function(){n=OT.$.getOrCreateWidgetContainerById(A,w);OT.$.getUserMedia({audio:true,video:true},OT._.bind(C,this),OT._.bind(z,this),OT._.bind(m,this),OT._.bind(s,this))},this);return this};this.publishAudio=function(H){w.publishAudio=H;E.muted=!H;if(F&&t){F.sendMessage(OT.WebSocketMessage.modifyStream(t.streamId,"hasAudio",H))}};this.publishVideo=function(L){var I=w.publishVideo;w.publishVideo=L;if(F&&t&&w.publishVideo!==I){F.sendMessage(OT.WebSocketMessage.modifyStream(t.streamId,"hasVideo",L))}var K=r.getVideoTracks();for(var J=0,H=K.length;J<H;++J){K[J].enabled=L}};this.recordQOS=function(){x.logQOS({widget_type:"Publisher",stream_type:"WebRTC",sessionId:F?F.sessionId:null,connectionId:F&&F.connected?F.connection.connectionId:null,partnerId:F?F.apiKey:OT.APIKEY,streamId:t?t.id:null,widgetId:j,version:OT.BUILD_PROPERTIES.version,media_server_name:F.sessionInfo.messagingServer,duration:new Date().getTime()-h.getTime()})};this.destroy=function(){OT.DOMComponentCleanup.remove(this);if(G){G.destroy();G=null}this.disconnect();E=null;if(v){v.destroy();v=null}i();if(n){OT.$.removeElement(n);n=null}if(this.session){this._.unpublishFromSession(this.session)}d=false;if(g){clearInterval(g)}A=null;t=null;e=false;F=null;_properties=null;this.trigger("destroyed",this);return this};this.disconnect=function(){for(var H in p){this.cleanupSubscriber(H)}};this.cleanupSubscriber=function(I){var H=p[I];if(H){H.destroy();delete p[I];f("disconnect","PeerConnection","subscriberConnection",I)}};this.processMessage=function(I,K,J){OT.debug("OT.rtc.Publisher.processMessage: Received "+I+" from "+K.id);OT.debug(J);switch(I){case OT.WebSocketMessageType.JSEP_UNSUBSCRIBE:this.cleanupSubscriber(K.id);break;default:var H=B.call(this,K);H.processMessage(I,J)}};this.getImgData=function(){if(!e){OT.error("OT.rtc.Publisher.getImgData: Cannot getImgData before the Publisher is publishing.");return null}return v.imgData};this._={publishToSession:OT._.bind(function(I){this.session=I;if(G){G.opentokButton.infoHref=OT.$.moreInfoLink(F)}var H=function(){I.sendMessage(OT.WebSocketMessage.createStream(this.guid,w&&w.name?w.name:"",OT.VideoOrientation.ROTATED_NORMAL,640,480,w.publishAudio,w.publishVideo,this.session.sessionInfo.p2pEnabled))};if(e){H.call(this)}else{this.on("loaded",OT._.bind(H,this))}f("publish","Attempt","streamType","WebRTC");return this},this),unpublishFromSession:OT._.bind(function(H){if(!this.session||H.id!==this.session.id){OT.warn("The publisher "+this.guid+" is trying to unpublish from a session "+H.id+" it is not attached to");return this}if(H.connected&&this.stream){H.sendMessage(OT.WebSocketMessage.destroyStream(this.stream.id))}this.disconnect();this.session=null;f("unpublish","Success","sessionId",H.id);return this},this),publishedToSessionHandler:OT._.bind(function(){h=new Date();d=true;g=setInterval(this.recordQOS,30000)},this)};this.detectDevices=function(){OT.warn("Fixme: Haven't implemented detectDevices")};this.detectMicActivity=function(){OT.warn("Fixme: Haven't implemented detectMicActivity")};this.getEchoCancellationMode=function(){OT.warn("Fixme: Haven't implemented getEchoCancellationMode");return"fullDuplex"};this.setMicrophoneGain=function(H){OT.warn("Fixme: Haven't implemented setMicrophoneGain")};this.getMicrophoneGain=function(){OT.warn("Fixme: Haven't implemented getMicrophoneGain");return 0.5};this.setCamera=function(H){OT.warn("Fixme: Haven't implemented setCamera")};this.setMicrophone=function(H){OT.warn("Fixme: Haven't implemented setMicrophone")};this.on("styleValueChanged",OT._.bind(q,this));this.__defineGetter__("id",function(){return A});this.__defineGetter__("guid",function(){return j});this.__defineGetter__("stream",function(){return t});this.__defineSetter__("stream",function(H){t=H});this.__defineGetter__("streamId",function(){if(!t){return null}return t.id});this.__defineGetter__("targetElement",function(){return v.domeElement});this.__defineGetter__("domId",function(){return A});this.__defineGetter__("session",function(){return F});this.__defineSetter__("session",function(H){F=H});this.__defineGetter__("isWebRTC",function(){return true});Object.defineProperty(this._,"webRtcStream",{get:function(){return r}})};OT.rtc.Publisher.nextId=uuid})(window);(function(a){OT.rtc.Subscriber=function(m,h){var c=uuid(),y=m||c,n,i={},B,q,k,A=h.session,e=false,x,w,g,s=OT._.clone(h),t=new OT.Analytics();if(!A){OT.handleJsException("Subscriber must be passed a session option",2000,{session:A,target:this});return}OT.eventing(this);OT.rtc.StylableComponent(this,{nameDisplayMode:"auto",buttonDisplayMode:"auto",backgroundImageURI:null});var f=function(E,C,D,F){t.logEvent({action:E,variation:C,payload_type:D,payload:F,stream_id:q?q.id:null,session_id:A?A.sessionId:null,connection_id:A&&A.connected?A.connection.connectionId:null,partner_id:A&&A.connected?A.sessionInfo.partnerId:null,widget_id:c,widget_type:"Subscriber"})},d=function(){return i.merged||i.video},b=function(){if(e||i.length===0){return}var C=OT._.every(i.values,function(D){return D.isBoundToStream});if(k&&k.connected){f("createPeerConnection","Opened","","");if(C){f("createPeerConnection","StreamAdded","","")}}if(!C||(k&&!k.connected)){return}OT.debug("OT.rtc.Subscriber.onLoaded");e=true;x=OT.$.now();f("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(x-w,10),k&&k.hasRelayCandidates].join("|"));g=setInterval(this.recordQOS,30000);OT.$.removeClass(n,"loading");r.call(this);this.trigger("loaded",this);f("subscribe","Success","streamId",q.id)},v=function(){OT.debug("OT.rtc.Subscriber has been disconnected from the Publisher's PeerConnection");this.disconnect()},u=function(C,D){if(!e){f("createPeerConnection","Failure","reason|hasRelayCandidates",["Subscriber PeerConnection Error: "+D,k&&k.hasRelayCandidates].join("|"))}this.disconnect();f("subscribe","Failure","reason","Subscriber PeerConnection Error: "+D);OT.handleJsException("Subscriber PeerConnection Error: "+D,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:A,target:this});p.call(this,D)},z=function(E,D){OT.debug("OT.rtc.Subscriber.onRemoteStreamAdded");this.subscribeToAudio(s.subscribeToAudio);this.subscribeToVideo(s.subscribeToVideo);var C=new OT.rtc.VideoElement();C.on({streamBound:OT._.bind(b,this),timeout:OT._.bind(u,this),error:OT._.bind(u,this)});if(D==="audio"){OT.$.addClass(C.domElement,"OT_hidden-audio")}C.bindToStream(E).appendTo(n.videoContainer);OT.DOMComponentCleanup.add(this,C);i[D]=C;if(D!=="audio"){this.streamOrientationDidChange(q.orientation.width,q.orientation.height,q.orientation.videoOrientation)}this.trigger("streamAdded",this)},j=function(D){OT.debug("OT.rtc.Subscriber.onStreamRemoved");for(var C in i){if(i[C].stream==D){i[C].destroy();delete i[C]}}this.trigger("streamRemoved",this)},o=function(D,E,C){if(!B){return}switch(D){case"nameDisplayMode":B.name.setDisplayMode(E);break;case"buttonDisplayMode":}},r=function(){B=new OT.Chrome({parent:n}).set({name:new OT.Chrome.NamePanel({name:s.name,mode:this.getStyle("nameDisplayMode")}),opentokButton:new OT.Chrome.OpenTokButton({infoHref:OT.$.moreInfoLink(A)})}).on({muted:function(){},unmuted:function(){}})},p=function(C){if(n){n.innerHTML="<p>"+C+"<p>"}OT.$.addClass(n,"OT_subscriber_error")};this.recordQOS=function(){if(e&&A&&A.connected){t.logQOS({widget_type:"Subscriber",stream_type:"WebRTC",session_id:A.sessionId,connectionId:A.connection.connectionId,media_server_name:A.sessionInfo.messagingServer,partner_id:A.apiKey,stream_id:q.id,widget_id:c,version:OT.BUILD_PROPERTIES.version,duration:parseInt(OT.$.now()-x,10)})}};this.subscribe=function(C){OT.debug("OT.rtc.Subscriber: subscribe to "+C.id);if(e){OT.error("OT.rtc.Subscriber.Subscribe: Cannot subscribe, already subscribing.");return false}if(!C){OT.error("OT.rtc.Subscriber: No stream parameter.");return false}if(q){OT.error("OT.rtc.Subscriber: Already subscribed");return false}q=C;y=m||uuid();s.name=q.name;s.classNames="OT_root OT_subscriber OT_loading";if(s.style){this.setStyle(s.style,null,true)}s.subscribeToAudio=OT.$.castToBoolean(s.subscribeToAudio,true);s.subscribeToVideo=OT.$.castToBoolean(s.subscribeToVideo,true);n=OT.$.getOrCreateWidgetContainerById(y,s);w=OT.$.now();if(q.connection.id!==A.connection.id){f("createPeerConnection","Attempt","","");k=new OT.rtc.SubscriberPeerConnection(q.connection,A,q);k.on({connected:OT._.bind(b,this),disconnected:OT._.bind(v,this),error:OT._.bind(u,this),remoteStreamAdded:OT._.bind(z,this),remoteStreamRemoved:OT._.bind(j,this)})}else{z.call(this,A.getPublisherForStream(q)._.webRtcStream,"merged");b.call(this)}f("subscribe","Attempt","streamId",q.id);return this};this.destroy=function(){OT.DOMComponentCleanup.remove(this);this.disconnect();if(B){B.destroy();B=null}for(var C in i){i[C].destroy();i[C].off("streamBound");i[C].off("timeout");i[C].off("error")}i={};if(n){OT.$.removeElement(n);n=null}if(q){f("unsubscribe",null,"streamId",q.id)}y=null;q=null;clearInterval(g);A=null;s=null;this.trigger("destroyed",this);return this};this.disconnect=function(){e=false;if(k){k.destroy();k=null;f("disconnect","PeerConnection","streamId",q.id)}};this.processMessage=function(C,E,D){OT.debug("OT.rtc.Subscriber.processMessage: Received "+C+" message from "+E.id);OT.debug(D);if(k){k.processMessage(C,D)}};this.getImgData=function(){if(!this.subscribing){OT.error("OT.rtc.Subscriber.getImgData: Cannot getImgData before the Subscriber is subscribing.");return null}return d().imgData};this.setAudioVolume=function(C){OT.warn("Fixme: Haven't implemented setAudioVolume")};this.getAudioVolume=function(){OT.warn("Fixme: Haven't implemented getAudioVolume");return 0.5};this.subscribeToAudio=function(C){s.subscribeToAudio=OT.$.castToBoolean(C,true);if(k){k.subscribeToAudio(C)}};this.subscribeToVideo=function(C){s.subscribeToVideo=OT.$.castToBoolean(C,true);if(k){k.subscribeToVideo(C)}};this.streamOrientationDidChange=function(E,C,D){d().orientation=D};this.on("styleValueChanged",OT._.bind(o,this));this.__defineGetter__("id",function(){return y});this.__defineGetter__("stream",function(){return q});this.__defineGetter__("targetElement",function(){return d()?d().domElement:null});this.__defineGetter__("subscribing",function(){return e});this.__defineGetter__("isWebRTC",function(){return true})}})(window);(function(a){OT.TokenPermissions=function(e){var c=null;this.sessionId=null;this.partnerId=null;this.connectionData="";this.validToken=true;this.capabilities={forceUnpublish:0,playback:0,publish:0,publishH264:0,record:0,subscribe:0};if(e.documentElement&&e.documentElement.firstElementChild!==null){c=e.documentElement.firstElementChild}OT.log("ValidateTokenResponse:");OT.log(e);if(c!==null&&c.localName.toLowerCase()=="token"){var d=c.firstElementChild;do{switch(d.localName){case"session_id":this.sessionId=d.textContent;break;case"partner_id":this.partnerId=d.textContent;break;case"permissions":var b=d.firstElementChild;do{switch(b.tagName){case"forceunpublish":this.capabilities.forceUnpublish=1;break;case"forcedisconnect":this.capabilities.forceDisconnect=1;break;case"playback":this.capabilities.playback=1;break;case"publish":this.capabilities.publish=1;break;case"publishH264":this.capabilities.publishH264=1;break;case"record":this.capabilities.record=1;break;case"subscribe":this.capabilities.subscribe=1;break}}while(b=b.nextElementSibling);OT.debug("Capabilities:"+JSON.stringify(this.capabilities));break;case"connection_data":this.connectionData=d.textContent;OT.log("ConnectionData: "+this.connectionData);break;case"invalid":OT.error("Token Invalid "+d.firstChild.textContent);this.validToken=false;break;default:break}}while(d=d.nextElementSibling)}else{this.validToken=false}}})(window);(function(a){OT.SessionInfo=function(j){var h=null;this.sessionId=null;this.partnerId=null;this.sessionStatus=null;this.p2pEnabled=false;this.messagingServer=null;this.iceServers=null;OT.log("SessionInfo Response:");OT.log(j);if(j&&j.documentElement&&j.documentElement.firstElementChild!==null){h=j.documentElement.firstElementChild}var f=h.firstElementChild;do{switch(f.localName){case"session_id":this.sessionId=f.textContent;break;case"partner_id":this.partnerId=f.textContent;break;case"session_status":this.sessionStatus=f.textContent;break;case"messaging_server_url":this.messagingServer=f.textContent;break;case"ice_servers":this.iceServers=[];var d=f.childNodes,k,e;for(var g=0,c=d.length;g<c;++g){if(d[g].localName==="ice_server"){e=d[g].attributes;k={url:e.getNamedItem("url").nodeValue};if(e.getNamedItem("credential")&&e.getNamedItem("credential").nodeValue.length){k.credential=e.getNamedItem("credential").nodeValue}this.iceServers.push(k)}}break;case"properties":var m=f.firstElementChild;if(m){do{if(m.localName==="p2p"&&m.firstElementChild!==null){this.p2pEnabled=(m.firstElementChild.textContent==="enabled");break}}while(m=m.nextElementSibling)}break;default:break}}while(f=f.nextElementSibling);h=null};OT.SessionInfo.get=function(g,h,f){var d=OT.BUILD_PROPERTIES.apiURL+"/session/"+g.id+"?extended=true",e=OT.$.now(),c=function(j){g.logEvent("Instrumentation",null,"gsi",OT.$.now()-e);var i=parseErrorFromXMLDocument(j);if(i===false){onGetResponseCallback(g,h,j)}else{onGetErrorCallback(g,f,i)}};g.logEvent("getSessionInfo","Attempt","api_url",OT.BUILD_PROPERTIES.apiURL);OT.$.getXML(d,{headers:{"X-TB-TOKEN-AUTH":g.token,"X-TB-VERSION":1},success:c,error:function(i){onGetErrorCallback(g,f,parseErrorFromXMLDocument(i.target.responseXML))}})};var b={};b["404"]=OT.ExceptionCodes.INVALID_SESSION_ID;b["403"]=OT.ExceptionCodes.AUTHENTICATION_ERROR;parseErrorFromXMLDocument=function(g){if(g&&g.documentElement&&g.documentElement.firstElementChild!==null){var e=g.evaluate("//error",g.documentElement,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),c=e.snapshotLength;if(c===0){return false}for(var d=0;d<c;++d){var f=e.snapshotItem(d);return{code:f.getAttribute("code"),message:f.firstElementChild.getAttribute("message")}}}return{code:null,message:"Unknown error: getSessionInfo XML response was badly formed"}};onGetResponseCallback=function(d,e,c){d.logEvent("getSessionInfo","Success","api_url",OT.BUILD_PROPERTIES.apiURL);e(new OT.SessionInfo(c))};onGetErrorCallback=function(e,d,c){TB.handleJsException("TB.SessionInfoError :: Unable to get session info "+c.message,b[c.code],{session:e});e.logEvent("getSessionInfo","Failure","errorMessage","TB.SessionInfoError :: Unable to get session info "+c.message);d(c,event)}})(window);(function(a){OT.Capabilities=function(b){this.publish=OT._.contains(b,"publish")?1:0;this.subscribe=OT._.contains(b,"subscribe")?1:0;this.forceUnpublish=OT._.contains(b,"forceunpublish")?1:0;this.forceDisconnect=OT._.contains(b,"forcedisconnect")?1:0;this.supportsWebRTC=OT.$.supportsWebRTC()?1:0}})(window);(function(c){var a=[],b=false;OT.Analytics=function(){var f=OT.BUILD_PROPERTIES.loggingURL+"/logging/ClientEvent",g=OT.BUILD_PROPERTIES.loggingURL+"/logging/ClientQos",h={},d={payloadType:"payload_type",streamId:"stream_id",sessionId:"session_id",connectionId:"connection_id",widgetType:"widget_type",widgetId:"widget_id"},i=function(o,m,p,n){OT.$.post(m?g:f,{success:p,error:n,data:o,headers:{"Content-Type":"application/x-www-form-urlencoded"}})},j=function(){if(!b&&a.length>0){b=true;var n=a[0];var m=function(){a.shift();b=false;j()};if(n){i(n.data,n.isQos,function(){n.onComplete();setTimeout(m,50)},function(){OT.debug("Failed to send ClientEvent, moving on to the next item.");setTimeout(m,50)})}}},e=function(n,o,m){a.push({data:n,onComplete:o,isQos:m});j()},k=function(p,o,q){if(!q){return false}var m=[q,o,p].join("_"),n=100;if(n===null||n===undefined){return false}return(h[m]||0)<=n};this.logError=function(r,p,q,o,n){if(!n){n={}}var t=n.partnerId;if(OT.Config.get("exceptionLogging","enabled",t)!==true){return}if(k(r,p,t)){return}var m=[t,p,r].join("_"),s=this.escapePayload(OT._.extend(o||{},{message:s,userAgent:navigator.userAgent}));h[m]=typeof(h[m])!=="undefined"?h[m]+1:1;return this.logEvent(OT._.extend(n,{action:p+"."+r,payloadType:s[0],payload:s[1]}))};this.logEvent=function(m){var q=m.partnerId;if(!m){m={}}var o=OT._.extend({variation:"",guid:m.connectionId||"",widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:q,source:c.location.href,section:"",build:""},m),p=function(){};for(var n in d){if(d.hasOwnProperty(n)&&o[n]){o[d[n]]=o[n];delete o[n]}}e(o,p,false)};this.logQOS=function(m){var q=m.partnerId;if(!m){m={}}var o=OT._.extend({guid:m.connectionId,widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:q,source:c.location.href,build:"",duration:0},m),p=function(){};for(var n in d){if(d.hasOwnProperty(n)&&o[n]){o[d[n]]=o[n];delete o[n]}}e(o,p,true)};this.escapePayload=function(p){var o=[],m=[];for(var n in p){if(p.hasOwnProperty(n)&&p[n]!==null&&p[n]!==undefined){o.push(p[n]?p[n].toString().replace("|","\\|"):"");m.push(n.toString().replace("|","\\|"))}}return[m.join("|"),o.join("|")]}}})(window);(function(a){OT.Session=function(H){if(!OT.checkSystemRequirements()){OT.upgradeSystemRequirements();return}var e,h=false,F=false,n,A={},M={},T={},O={},L,o,s=H,R=false,f,d={},y=uuid(),V={},q=new OT.Analytics();OT.eventing(this);function v(X){for(var Y in M){var W=M[Y];if(X===W.streamId){return W}}return null}function B(W){if(!W.connection||!A[W.connection.connectionId]){OT.warn("Received a stream for a connection that doesn't exist");OT.debug(W);return false}return true}function r(W){return O[W]}function S(W){W.forEach(J)}function J(W){O[W.id]=W}function m(W){delete O[W]}function p(Z,X,Y){var aa=r(Z),W=aa[X];aa.update(X,Y);return W}var x=function(W){h=true;F=false;n=W.connectionId;d=new OT.Capabilities(W.permissions);W.connections.forEach(function(X){A[X.connectionId]=X});W.streams=OT._.filter(W.streams,function(X){return B(X)});S(W.streams);this.dispatchEvent(new OT.SessionConnectEvent(OT.Event.names.SESSION_CONNECTED,W.connections,W.streams,W.archives))},c=function(W){h=false;F=false;OT.error(W.reason);this.trigger("sessionConnectFailed",W.reason);switch(W.code){case 409:TB.handleJsException("TB.SessionConnectionFailed :: The P2P session already has two participants.",OT.ExceptionCodes.CONNECT_REJECTED,{session:this});break;case 410:TB.handleJsException("TB.SessionConnectionFailed :: The session already has four participants.",OT.ExceptionCodes.CONNECT_REJECTED,{session:this});break;default:TB.handleJsException("TB.SessionConnectionFailed :: The session failed to connect.",OT.ExceptionCodes.CONNECT_FAILED,{session:this});break}},C=function(X,W){TB.handleJsException(X,W,{session:this})},U=function(Y){var X=new OT.SessionDisconnectEvent("sessionDisconnected",Y.reason);G.call(this);D.call(this);var W=function(){if(!X.isDefaultPrevented()){i.call(this)}};this.dispatchEvent(X,OT._.bind(W,this))},K=function(W){A[W.connection.connectionId]=W.connection;W.connections=[W.connection];delete W.connection;this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_CREATED,W.connections))},E=function(X){if(n!==X.connection.connectionId){delete A[X.connection.connectionId]}for(var W in M){M[W].cleanupSubscriber(X.connection.connectionId)}X.connections=[X.connection];delete X.connection;this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_DESTROYED,X.connections,X.reason))},g=function(X){OT.debug(X.streams);if(X.streams.length===0){return}S(X.streams);var W;X.streams.forEach(function(Y){if(Y.publisherId){W=M[Y.publisherId];delete Y.publisherId}else{W=this.getPublisherForStream(Y.id)}if(W){W.stream=Y}})},w=function(W){W.streams=OT._.filter(W.streams,B);OT.debug(W.streams);if(W.streams.length>0){S(W.streams);W.streams.forEach(function(Y){var X=v(Y.id);if(X){X._.publishedToSessionHandler()}});this.dispatchEvent(new OT.StreamEvent(OT.Event.names.STREAM_CREATED,W.streams,W.reason))}},t=function(Y){OT.debug(Y);var aa={orientation:"videoDimensions",hasAudio:"hasAudio",hasVideo:"hasVideo"};var ac=Y.key.split("/"),ad=r(Y.streamId),ae,ab,Z,X=Y.value,W;ac=ac.length>0?ac[ac.length-1]:null;if(!ac||!aa[ac]){OT.warn("Unknown stream property was modified.");return}ab=aa[ac];W=p(Y.streamId,ab,Y.value);if(ac==="orientation"){ae=T[Y.streamId];if(ae){ae.streamOrientationDidChange(Y.value.width,Y.value.height,Y.value.videoOrientation)}X={width:X.width,height:X.height}}this.dispatchEvent(new OT.StreamPropertyChangedEvent(OT.Event.names.STREAM_PROPERTY_CHANGED,ad,ab,W,X))},b=function(Y){if(Y.streams.length<=0){return}Y.streams=OT._.filter(Y.streams,function(Z){return B(Z)});var X=new OT.StreamEvent("streamDestroyed",Y.streams,Y.reason);var W=function(){var Z=!X.isDefaultPrevented();Y.streams.forEach(function(ad){var ab=v(ad.id);if(ab){ab.disconnect();if(Z){u(ab)}delete M[ab.guid]}for(var ac in T){if(ac===ad.id){var aa=T[ac];aa.disconnect();if(Z){this.unsubscribe(aa)}delete T[ac]}}m(ad.id)},this)};this.dispatchEvent(X,OT._.bind(W,this))},j=function(X){OT.log("jsepMessageHandler: "+JSON.stringify(X));if(!A[X.fromAddress]){OT.warn("OT.Session.onMessage: Received peerConnectionData from an unknown connection.");A[X.fromAddress]=new OT.Connection(X.fromAddress,new Date(),null,{supportsWebRTC:true})}if(X.hasOwnProperty("streamId")){var W=null;if(X.type==OT.WebSocketMessageType.JSEP_SUBSCRIBE||X.type==OT.WebSocketMessageType.JSEP_UNSUBSCRIBE){W=v(X.streamId,true)}else{W=v(X.streamId,true)||T[X.streamId]}if(!W){OT.warn("OT.Session.onMessage: Received peerConnectionData for an unknown publisher.");return}W.processMessage(X.type,A[X.fromAddress],X)}},k=function(X){var W=new OT.SignalEvent("signalReceived",A[X.fromAddress]);this.dispatchEvent(W)},G=function(){L=null;o=null;n=null;h=false;d=null;A={};O={}},D=function(){for(var W in M){M[W].disconnect()}for(var X in T){T[X].disconnect()}},u=function(W){if(V[W.guid]){W.off("destroyed",V[W.guid]);delete V[W.guid]}W.destroy()},i=function(){for(var W in M){u(M[W])}M={};V={};for(var X in T){T[X].destroy()}T={}},I=function(W){V[W.guid]=OT._.bind(function(){this.unpublish(W)},this);W.on("destroyed",V[W.guid])},P=function(){TB.log("connectToMessenger");this.properties={requireConnectionObjects:true};var W=function(X){return function(Y){return function(){return Y.apply(X,arguments)}}}(this);f=new OT.Messenger(this.sessionInfo.messagingServer,new OT.SessionMessageWrangler(this)).on({SessionConnected:W(x),SessionConnectFailed:W(c),ConnectionClosed:W(U),ConnectionCreated:W(K),ConnectionDestroyed:W(E),StreamRegistered:W(g),StreamCreated:W(w),StreamModified:W(t),StreamDestroyed:W(b),JSEPMessageReceived:W(j),SignalReceived:W(k),exception:W(C)});f.connect(s,o,{requireConnectionObjects:this.properties.requireConnectionObjects,p2pEnabled:this.sessionInfo.p2pEnabled,widgetId:y,partnerId:L})},N=function(){if(F){OT.SessionInfo.get(this,OT._.bind(Q,this),function(){F=false})}},Q=function(W){if(F){this.sessionInfo=W;if(this.sessionInfo.partnerId){L=this.sessionInfo.partnerId}P.call(this)}},z=function(W){return d[W]===1};this.logEvent=function(Y,X,W,Z){q.logEvent({action:Y,variation:X,payload_type:W,payload:Z,session_id:s,partner_id:L,widget_id:y,widget_type:"Controller"})};this.connect=function(Y,X,W){if(h){OT.warn("OT.Session: Cannot connect, already connected.");return}if(F){OT.warn("OT.Session: Cannot connect, already connecting.");return}F=true;G.call(this);L=Y.toString();if(OT.APIKEY.length===0){OT.APIKEY=L}o=X;N.call(this)};this.disconnect=function(){F=false;if(f){f.disconnect();f=null;R=false}};this.publish=function(Y,W){var X;if(!h){q.logError(1010,"tb.exception","We need to be connected before you can publish",null,{action:"publish",variation:"Failure",payload_type:"reason",payload:"We need to be connected before you can publish",session_id:s,partner_id:L,widgetId:y,widget_type:"Controller"});X="We need to be connected before you can publish";OT.error(X);throw new Error(X)}if(!z("publish")){q.logEvent({action:"publish",variation:"Failure",payload_type:"reason",payload:"This token does not allow publishing. The role must be at least `publisher` to enable this functionality",session_id:s,partner_id:L,widgetId:y,widget_type:"Controller"});TB.handleJsException("This token does not allow publishing. The role must be at least `publisher` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_PUBLISH,{session:this});return null}if(!Y||typeof(Y)==="string"){Y=OT.initPublisher(this.apiKey,Y,W)}else{if(Y instanceof OT.rtc.Publisher||Y instanceof OT.flash.Publisher){if("session" in Y&&Y.session&&"sessionId" in Y.session){if(Y.session.sessionId===this.sessionId){OT.warn("Cannot publish "+Y.guid+" again to "+this.sessionId+". Please call session.unpublish(publisher) first.")}else{OT.warn("Cannot publish "+Y.guid+" publisher already attached to "+Y.session.sessionId+". Please call session.unpublish(publisher) first.")}}}else{X="Session.publish :: First parameter passed in is neither a string nor an instance of the Publisher";OT.error(X);throw new Error(X)}}M[Y.guid]=Y;Y._.publishToSession(this);I.call(this,Y);return Y};this.unpublish=function(W){if(!W){OT.error("OT.Session.unpublish: publisher parameter missing.");return}W._.unpublishFromSession(this)};this.modifyStream=function(Y,W,X){if(!Y||!W||!X){OT.error("OT.Session.modifyStream: must provide streamId, key and value to modify a stream property.")}f.sendMessage(OT.WebSocketMessage.modifyStream(Y,W,X))};this.subscribe=function(aa,W,X){var Z;if(!this.connection||!this.connection.connectionId){Z="Session.subscribe :: Connection required to subscribe";OT.error(Z);throw new Error(Z)}if(!aa){Z="Session.subscribe :: stream cannot be null";OT.error(Z);throw new Error(Z)}if(!aa.hasOwnProperty("streamId")){Z="Session.subscribe :: invalid stream object";OT.error(Z);throw new Error(Z)}var Y=new OT.rtc.Subscriber(W,OT._.extend(X||{},{session:this}));T[aa.streamId]=Y;Y.subscribe(aa);return Y};this.unsubscribe=function(W){if(!W){var X="OT.Session.unsubscribe: subscriber cannot be null";OT.error(X);throw new Error(X)}if(!W.stream){OT.warn("OT.Session.unsubscribe:: tried to unsubscribe a subscriber that had no stream");return false}OT.debug("OT.Session.unsubscribe: subscriber "+W.id);delete T[W.stream.id];W.destroy();return true};this.getSubscribersForStream=function(W){return[T[W.id]]};this.getPublisherForStream=function(X){var W;if(typeof(X)=="string"){W=X}else{if(typeof(X)=="object"&&X&&X.hasOwnProperty("id")){W=X.id}else{errorMsg="Session.getPublisherForStream :: Invalid stream type";OT.error(errorMsg);throw new Error(errorMsg)}}return v(W)};this.sendMessage=function(){return f.sendMessage.apply(f,arguments)};this.sendJSEPMessage=function(Y,W,X){if(f&&f.connectionId){f.sendMessage(OT.WebSocketMessage.jsepMessage(f.connectionId,Y.connectionId,W,X))}else{OT.warn("Session.sendJSEPMessage :: Tried to send a message without a _messenger")}};this.forceDisconnect=function(W){if(z("forceDisconnect")){var X=typeof(W)==="string"?W:W.id;f.sendMessage(OT.WebSocketMessage.forceDisconnect(X))}else{TB.handleJsException("This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_FORCE_DISCONNECT,{session:this})}};this.forceUnpublish=function(W){if(z("forceUnpublish")){var X=typeof(W)==="string"?W:W.id;f.sendMessage(OT.WebSocketMessage.forceUnpublish(X))}else{TB.handleJsException("This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_FORCE_UNPUBLISH,{session:this})}};this.getStateManager=function(){OT.warn("Fixme: Have not implemented session.getStateManager")};this.__defineGetter__("apiKey",function(){return L});this.__defineGetter__("token",function(){return o});this.__defineGetter__("connected",function(){return h});this.__defineGetter__("connection",function(){return A[n]});this.__defineSetter__("connection",function(W){if(W.hasOwnProperty("connectionId")){n=W.connectionId;A[n]=W}});this.__defineGetter__("capabilities",function(){return d});this.__defineGetter__("sessionId",function(){return s});this.__defineGetter__("id",function(){return s});this.__defineGetter__("connections",function(){return A});this.__defineGetter__("publishers",function(){return M})}})(window);(function(a){OT.SessionMessageWrangler=function(f){var d=function(g){return new OT.Connection(g.connectionId,g.creationTime,g.data,{supportsWebRTC:g.supportsWebRTC})},e=function(g){return Object.keys(g).map(function(h){return d(g[h])})},b=function(h,g){function i(n){if(f.connections[h.connection.connectionId]){return f.connections[h.connection.connectionId]}else{if(g){for(var k=0,m=g.length;k<m;++k){if(n===g[k].id){return g[k]}}}}return null}var j=new OT.Stream(h.streamId,i(h.connection.connectionId),h.name,h.streamData,h.type,h.creationTime,h.hasAudio,h.hasVideo,h.orientation?h.orientation:{videoOrientation:OT.VideoOrientation.ROTATED_NORMAL,width:640,height:480},f.id,h.peerId,h.quality,h.orientation?h.orientation.width:640,h.orientation?h.orientation.height:480);if(h.publisherId){j.publisherId=h.publisherId}return j},c=function(i,h){var k=[];for(var g in i){if(i.hasOwnProperty(g)){var j=b(i[g],h);if(j){k.push(j)}}}return k};this.wrangle=function(g){if(g.sessionState){if(g.sessionState.CONNECTIONS){g.connections=e(g.sessionState.CONNECTIONS)}if(g.sessionState.STREAMS){g.streams=c(g.sessionState.STREAMS,g.connections)}}else{if(g.streams){g.streams=c(g.streams,g.connections)}if(g.connection){g.connection=d(g.connection)}}return g}}})(window);(function(a){OT.onLoad(function(){var c=document.createElement("link");c.type="text/css";c.media="screen";c.rel="stylesheet";c.href=OT.BUILD_PROPERTIES.cssURL+"/ot.css";var b=document.head||document.getElementsByTagName("head")[0];b.appendChild(c)})})(window);


OpenTok = TB;
